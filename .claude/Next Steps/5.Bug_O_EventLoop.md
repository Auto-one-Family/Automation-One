# Entwickler-Briefing: Bug O - AsyncIO Event-Loop-Konflikt

> **Letzte Aktualisierung:** 2026-01-05
> **Status:** OFFEN (sporadisch, nicht kritisch)
> **Priorität:** Low (Server läuft stabil, Workaround: Neustart)

---

## Kontext: Bug Q wurde erfolgreich gelöst

**Was war Bug Q?**
- Wokwi ESP32-Simulation produzierte ZERO Serial-Ausgabe
- **Root Cause:** Fehlende `$serialMonitor` Verbindung in `diagram.json`
- **Lösung:** `["esp:TX0", "$serialMonitor:RX", "", []]` hinzugefügt
- **Verifiziert:** Workflow Run 20706888212 - alle 5 Boot-Phasen OK

**Commits:**
- `c2f1e36` - fix(wokwi): Add Serial Monitor connection
- `1f7900e` - docs(bugs): Bug Q verifiziert

---

## Bug O: AsyncIO Event-Loop-Konflikt

### Symptom

Server läuft normal, aber nach längerer Laufzeit erscheint sporadisch:
```
RuntimeError: Queue bound to different event loop
```

### Bekannte Fakten

1. **Wann tritt es auf?** Nach längerer Server-Laufzeit (Stunden/Tage)
2. **Wie oft?** Sporadisch, nicht reproduzierbar
3. **Auswirkung:** Server läuft weiter, aber manche async Operationen schlagen fehl
4. **Workaround:** Server neu starten

### Vermutete Root Cause

MQTT-Subscriber Thread-Pool + Python 3.12+ Event-Loop-Binding:
- MQTT-Handler laufen in einem ThreadPoolExecutor
- Jeder Thread hat potenziell einen eigenen Event-Loop
- Async Queues werden im Main-Event-Loop erstellt
- Wenn ein Thread versucht, auf eine Queue zuzugreifen, die an einen anderen Event-Loop gebunden ist → RuntimeError

### Relevante Code-Locations

| Komponente | Datei | Beschreibung |
|------------|-------|--------------|
| MQTT Subscriber | `El Servador/god_kaiser_server/src/mqtt/subscriber.py` | ThreadPoolExecutor für Handler |
| MQTT Handler Base | `El Servador/god_kaiser_server/src/mqtt/handlers/base_handler.py` | Error-Isolation |
| Central Scheduler | `El Servador/god_kaiser_server/src/core/scheduler.py` | APScheduler Instance |
| Main Lifespan | `El Servador/god_kaiser_server/src/main.py` | Startup/Shutdown Orchestration |

### Dokumentations-Referenzen (CLAUDE.md)

Konsultiere `.claude/CLAUDE.md` für:

| Aufgabe | Section | Quick-Link |
|---------|---------|------------|
| Server-Architektur verstehen | Section 11.1 | MQTT-System, Service-Layer |
| Server starten/stoppen | Quick Reference → `DEBUG_ARCHITECTURE.md` Section 0 | - |
| Server-Logs prüfen | Quick Reference → `DEBUG_ARCHITECTURE.md` Section 0.5 | `logs/god_kaiser.log` |
| Tests ausführen | `.claude/CLAUDE_SERVER.md` Section 12 | `poetry run pytest` |

### Lösungsansätze (TODO)

1. **Prüfen:** Alle async Queues im Main-Event-Loop erstellen
   - Suche nach `asyncio.Queue()` Aufrufen
   - Stelle sicher, dass sie im Main-Thread erstellt werden

2. **APScheduler:** Auf `AsyncIOScheduler` umstellen
   - Aktuell: `BackgroundScheduler` (Thread-basiert)
   - Ziel: `AsyncIOScheduler` (Event-Loop-kompatibel)

3. **ThreadPool:** Durch `asyncio.to_thread()` ersetzen
   - Aktuell: `ThreadPoolExecutor` in MQTT Subscriber
   - Ziel: Native asyncio Thread-Integration

### Debugging-Befehle

```bash
# Server-Logs live verfolgen
cd "El Servador/god_kaiser_server"
tail -f logs/god_kaiser.log | grep -i "event loop\|queue\|runtime"

# Server starten mit Debug-Logging
poetry run uvicorn god_kaiser_server.src.main:app --reload --log-level debug

# Nach Event-Loop Problemen suchen
grep -r "asyncio.Queue\|ThreadPoolExecutor\|event_loop" src/

# Tests ausführen
poetry run pytest tests/unit/ -v -k "mqtt or scheduler"
```

### Erfolgskriterium

- Server läuft 48+ Stunden ohne Event-Loop-Fehler
- Keine `RuntimeError: Queue bound to different event loop` im Log

---

## Workflow für Bug-Fixing (Best Practices aus Bug Q)

1. **Recherche:** Nutze Internet-Quellen für Python 3.12+ Event-Loop-Änderungen
2. **Lokalisiere:** Finde alle Thread/Event-Loop Interaktionen
3. **Implementiere:** Kleinste mögliche Änderung
4. **Teste:** `poetry run pytest tests/` + manueller Long-Running-Test
5. **Dokumentiere:** Update `Bugs_Found.md` mit Root Cause und Lösung
6. **Verifiziere:** Server 24+ Stunden laufen lassen

---

## Quick Reference: Projekt-Navigation

```
Auto-one/
├── .claude/
│   ├── CLAUDE.md              # Haupt-KI-Dokumentation (START HIER!)
│   ├── CLAUDE_SERVER.md       # Server-spezifische Doku
│   ├── CLAUDE_FRONTEND.md     # Frontend-spezifische Doku
│   └── Next Steps/            # Bug-Briefings (diese Datei)
├── El Servador/               # Python FastAPI Server
│   └── god_kaiser_server/
│       ├── src/               # Quellcode
│       ├── tests/             # Tests
│       └── logs/              # Log-Dateien
├── El Trabajante/             # ESP32 Firmware
└── El Frontend/               # Vue.js Frontend
    └── Docs/Bugs_and_Phases/
        └── Bugs_Found.md      # Zentrale Bug-Dokumentation
```

---

**Viel Erfolg!**
