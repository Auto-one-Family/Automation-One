# Wokwi ESP32 Simulation - Entwickler-Handbuch

> **Stand:** 2026-01-06
> **Autoren:** Claude Code (Sessions mit Robin)
> **Zweck:** VollstÃ¤ndige Anleitung fÃ¼r Wokwi-Integration, Debugging und CI/CD
> **Status:** âœ… VOLLSTÃ„NDIG FUNKTIONSFÃ„HIG - MQTT-Verbindung erfolgreich!

---

## WICHTIG: KI-Agenten Workflow

> **Der User startet Wokwi MANUELL!**
> Die KI ist dafÃ¼r verantwortlich:
> 1. Server zu starten (uvicorn)
> 2. Frontend zu starten (npm run dev)
> 3. Mosquitto zu prÃ¼fen (lÃ¤uft als Windows Service)
> 4. ESP_00000001 in der Datenbank zu registrieren (falls nicht vorhanden)
>
> **Der User startet dann selbst die Wokwi-Simulation Ã¼ber VS Code Extension oder CLI.**

---

## 0. Quick Reference - TL;DR

### FÃ¼r KI-Agenten: Services starten
```powershell
# 1. Mosquitto prÃ¼fen (lÃ¤uft als Windows Service)
netstat -ano | findstr "1883"

# 2. Server starten (Background)
cd "c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\El Servador\god_kaiser_server"
poetry run uvicorn src.main:app --reload --host 0.0.0.0 --port 8000

# 3. Frontend starten (Background)
cd "c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\El Frontend"
npm run dev

# 4. Wokwi-ESP registrieren (falls nicht vorhanden)
cd "c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\El Servador\god_kaiser_server"
poetry run python scripts/seed_wokwi_esp.py
```

### FÃ¼r User: Wokwi manuell starten
```powershell
# Option A: VS Code Wokwi Extension
# - Ã–ffne El Trabajante/diagram.json
# - Klicke auf "Start Simulation" (Play-Button)

# Option B: Wokwi CLI
cd "c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\El Trabajante"
~/.platformio/penv/Scripts/platformio.exe run -e wokwi_simulation
C:\Users\PCUser\.wokwi\bin\wokwi-cli.exe . --timeout 0

# Option C: Batch-Script
c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\scripts\run-wokwi.bat
```

### ESP Device Info
- **ESP ID:** `ESP_00000001` (NICHT ESP_00000001!)
- **MQTT Topics:** `kaiser/god/esp/ESP_00000001/...`
- **Frontend:** Erscheint unter "ESP_00000001" oder "Wokwi Simulation ESP"

---

## 1. Projektstruktur - Wichtige Pfade

### 1.1 Haupt-Verzeichnisse

| Pfad | Beschreibung |
|------|--------------|
| `Auto-one/` | Projekt-Root |
| `Auto-one/El Trabajante/` | ESP32 Firmware (PlatformIO) |
| `Auto-one/El Servador/god_kaiser_server/` | Python FastAPI Server |
| `Auto-one/El Frontend/` | Vue.js Frontend |
| `Auto-one/.claude/` | KI-Dokumentation & Commands |
| `Auto-one/scripts/` | Hilfs-Scripts (PowerShell, Batch, Python) |

### 1.2 ESP32 Firmware - Kritische Dateien

| Datei | Zweck |
|-------|-------|
| `El Trabajante/platformio.ini` | Build-Konfiguration, **Environment `wokwi_simulation`** |
| `El Trabajante/wokwi.toml` | Wokwi CLI Konfiguration |
| `El Trabajante/diagram.json` | Virtuelle Hardware-Definition |
| `El Trabajante/src/models/system_types.h` | `kaiser_id = "god"` (Default) |
| `El Trabajante/src/services/communication/mqtt_client.*` | MQTT-Verbindungslogik |
| `El Trabajante/src/services/config/config_manager.cpp` | Wokwi-Credentials (Compile-Time) |

### 1.3 Server - Kritische Dateien

| Datei | Zweck |
|-------|-------|
| `El Servador/god_kaiser_server/src/main.py` | FastAPI Entry Point |
| `El Servador/god_kaiser_server/src/mqtt/handlers/` | MQTT Message Handler |
| `El Servador/god_kaiser_server/scripts/seed_wokwi_esp.py` | ESP_00000001 in DB registrieren |
| `El Servador/god_kaiser_server/scripts/init_db.py` | Datenbank initialisieren |

### 1.4 Externe Konfigurationsdateien

| Datei | Zweck |
|-------|-------|
| `C:\Program Files\mosquitto\mosquitto.conf` | Mosquitto MQTT Broker Config |
| `C:\Program Files\mosquitto\mosquitto.log` | Mosquitto Logs (oft gesperrt!) |
| `C:\Users\PCUser\.wokwi\bin\wokwi-cli.exe` | Wokwi CLI Binary |

### 1.5 Hilfs-Scripts

| Script | Pfad | Beschreibung |
|--------|------|--------------|
| `run-wokwi.bat` | `scripts/run-wokwi.bat` | Startet Wokwi CLI mit Token |
| `wokwi_serial_logger.py` | `El Trabajante/scripts/wokwi_serial_logger.py` | Loggt Serial-Output via RFC2217 |

---

## 2. Prozesse - Starten & Stoppen

### 2.1 Mosquitto MQTT Broker

**Status prÃ¼fen:**
```powershell
# PrÃ¼fen ob Mosquitto lÃ¤uft
netstat -an | findstr 1883

# Erwartete Ausgabe wenn aktiv:
# TCP    0.0.0.0:1883    LISTENING     (alle Interfaces)
# TCP    127.0.0.1:1883  127.0.0.1:xxxxx  ESTABLISHED  (aktive Verbindungen)
```

**Starten/Stoppen (Windows Service):**
```powershell
# Als Administrator:
net start mosquitto
net stop mosquitto

# Oder Ã¼ber Services GUI:
services.msc â†’ "Mosquitto Broker"
```

**Manuell starten (fÃ¼r Debugging mit verbose output):**
```powershell
& "C:\Program Files\mosquitto\mosquitto.exe" -c "C:\Program Files\mosquitto\mosquitto.conf" -v
```

**Konfiguration prÃ¼fen:**
```powershell
# Aktuelle Config anzeigen
Get-Content "C:\Program Files\mosquitto\mosquitto.conf" | Select-String -Pattern "listener|allow_anonymous"

# Erwartet:
# allow_anonymous true
# listener 1883
```

### 2.2 God-Kaiser Server (Python FastAPI)

**Starten:**
```powershell
cd "c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\El Servador\god_kaiser_server"
poetry run uvicorn god_kaiser_server.src.main:app --reload --host 0.0.0.0 --port 8000
```

**Stoppen:** `Ctrl+C` im Terminal

**Status prÃ¼fen:**
```powershell
# HTTP Health Check
curl http://localhost:8000/api/v1/health

# PrÃ¼fen ob Port 8000 belegt
netstat -an | findstr 8000
```

**ESP_00000001 in DB registrieren (einmalig):**
```powershell
cd "c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\El Servador\god_kaiser_server"
poetry run python scripts/seed_wokwi_esp.py
```

### 2.3 Wokwi Simulation

**VS Code Extension (NICHT EMPFOHLEN fÃ¼r MQTT):**
- `Ctrl+Shift+P` â†’ "Wokwi: Start Simulation"
- **ACHTUNG:** Netzwerk-Support eingeschrÃ¤nkt! MQTT funktioniert NICHT zuverlÃ¤ssig.

**Wokwi CLI (EMPFOHLEN):**
```powershell
# Token setzen (bereits permanent gesetzt als User-Variable)
$env:WOKWI_CLI_TOKEN='wok_F9PGu0KSKMTupAZUUzEf6vFHyenjcYI420b4b725'

# Simulation starten (unbegrenztes Timeout mit 0)
cd "c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\El Trabajante"
C:\Users\PCUser\.wokwi\bin\wokwi-cli.exe . --timeout 0

# Mit Timeout (60 Sekunden):
C:\Users\PCUser\.wokwi\bin\wokwi-cli.exe . --timeout 60000

# Mit Szenario (fÃ¼r CI):
C:\Users\PCUser\.wokwi\bin\wokwi-cli.exe . --timeout 90000 --scenario tests/wokwi/boot_test.yaml
```

**Batch-Script verwenden:**
```powershell
c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\scripts\run-wokwi.bat
```

**Stoppen:** `Ctrl+C`

### 2.4 Frontend (Vue.js)

```powershell
cd "c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\El Frontend"
npm run dev
```

### 2.5 Alle Services gleichzeitig (4 Terminals)

```
Terminal 1: Mosquitto (Service lÃ¤uft automatisch)
Terminal 2: poetry run uvicorn ... (Server)
Terminal 3: mosquitto_sub -t "kaiser/#" -v (MQTT Monitor)
Terminal 4: wokwi-cli . --timeout 0 (Wokwi)
```

---

## 3. Logs - Wo lesen?

### 3.1 Log-Ãœbersicht

| Log | Pfad | Inhalt |
|-----|------|--------|
| **Mosquitto** | `C:\Program Files\mosquitto\mosquitto.log` | MQTT Broker Events |
| **Server** | `El Servador/god_kaiser_server/logs/god_kaiser.log` | Server-Logs (JSON) |
| **Wokwi Serial** | `El Trabajante/logs/wokwi_serial.log` | ESP32 Serial Output |
| **PlatformIO Build** | Terminal-Output | Kompilierungs-Logs |

### 3.2 Mosquitto Logs lesen

```powershell
# ACHTUNG: Datei oft gesperrt! Erst kopieren:
Copy-Item "C:\Program Files\mosquitto\mosquitto.log" "$env:TEMP\mosquitto_copy.log"
Get-Content "$env:TEMP\mosquitto_copy.log" -Tail 100

# Nach ESP suchen:
Select-String -Path "$env:TEMP\mosquitto_copy.log" -Pattern "ESP_00000001"
```

### 3.3 Server Logs lesen

```powershell
# Letzte 100 Zeilen
Get-Content "El Servador/god_kaiser_server/logs/god_kaiser.log" -Tail 100

# Nach ESP filtern
Select-String -Path "El Servador/god_kaiser_server/logs/god_kaiser.log" -Pattern "ESP_00000001"

# Live-Tail
Get-Content "El Servador/god_kaiser_server/logs/god_kaiser.log" -Wait -Tail 20
```

### 3.4 Wokwi Serial Logs

```powershell
# Logger starten (separates Terminal) - verbindet via RFC2217 auf Port 4000
cd "c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\El Trabajante"
python scripts/wokwi_serial_logger.py

# Logs lesen
Get-Content logs/wokwi_serial.log -Wait -Tail 50
```

---

## 4. MQTT Debugging

### 4.1 MQTT Topics abonnieren

```powershell
# Alle Kaiser-Topics (zeigt alle Nachrichten)
mosquitto_sub -h localhost -p 1883 -t "kaiser/#" -v

# Nur ESP_00000001 Heartbeats
mosquitto_sub -h localhost -p 1883 -t "kaiser/god/esp/ESP_00000001/system/heartbeat" -v

# Alle Sensor-Daten
mosquitto_sub -h localhost -p 1883 -t "kaiser/+/esp/+/sensor/+/data" -v

# Alle System-Topics
mosquitto_sub -h localhost -p 1883 -t "kaiser/+/esp/+/system/#" -v
```

### 4.2 Test-Nachrichten senden

```powershell
# Heartbeat simulieren
mosquitto_pub -h localhost -p 1883 -t "kaiser/god/esp/ESP_00000001/system/heartbeat" -m '{"esp_id":"ESP_00000001","heap_free":200000,"uptime":12345,"wifi_rssi":-65,"state":"STATE_OPERATIONAL","timestamp":1704067200}'

# Actuator Command senden
mosquitto_pub -h localhost -p 1883 -t "kaiser/god/esp/ESP_00000001/actuator/5/command" -m '{"action":"set","value":1.0,"command_id":"test-001"}'
```

### 4.3 Python MQTT Listener (fÃ¼r Debugging)

```python
# Speichern als: scripts/mqtt_debug_listener.py
import paho.mqtt.client as mqtt

def on_connect(client, userdata, flags, rc):
    print(f"Connected with result code {rc}")
    client.subscribe("kaiser/#")

def on_message(client, userdata, msg):
    print(f"{msg.topic}: {msg.payload.decode()}")

client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message
client.connect("localhost", 1883, 60)
client.loop_forever()
```

---

## 5. Wokwi Konfiguration - Details

### 5.1 wokwi.toml (aktuell)

```toml
[wokwi]
version = 1
firmware = ".pio/build/wokwi_simulation/firmware.bin"
elf = ".pio/build/wokwi_simulation/firmware.elf"

# RFC2217 Serial Port fÃ¼r externen Zugriff (Port 4000)
rfc2217ServerPort = 4000

# Netzwerk-Gateway aktivieren
[wokwi.network]
gateway = true
# HINWEIS: host.wokwi.internal wird automatisch zum Host aufgelÃ¶st
# Windows Firewall muss Port 1883 erlauben!

[wokwi.serial]
baud = 115200
```

### 5.2 platformio.ini - Wokwi Environment

```ini
[env:wokwi_simulation]
extends = env:esp32_dev
build_flags =
    ${env:esp32_dev.build_flags}
    ; Wokwi Simulation Mode
    -D WOKWI_SIMULATION=1
    ; WiFi credentials for Wokwi (Wokwi-GUEST is open network)
    -D WOKWI_WIFI_SSID=\"Wokwi-GUEST\"
    -D WOKWI_WIFI_PASSWORD=\"\"
    ; MQTT broker via Wokwi Gateway (routes to localhost or CI service)
    -D WOKWI_MQTT_HOST=\"host.wokwi.internal\"
    -D WOKWI_MQTT_PORT=1883
    ; Optional: Pre-configured ESP ID for reproducible tests
    -D WOKWI_ESP_ID=\"ESP_00000001\"
```

### 5.3 diagram.json

Definiert die virtuelle Hardware (ESP32 Board, Sensoren, etc.).
Bearbeiten Ã¼ber VS Code Wokwi Extension oder manuell.
Pfad: `El Trabajante/diagram.json`

---

## 6. Bekannte Probleme & LÃ¶sungen

### 6.1 MQTT "Connection reset by peer"

**Symptom:**
```
[E][WiFiClient.cpp:275] connect(): socket error on fd 48, errno: 104, "Connection reset by peer"
```

**Ursachen:**
1. **Windows Firewall blockiert Port 1883** fÃ¼r externe Verbindungen
2. **Mosquitto bindet nur auf localhost** (127.0.0.1)

**LÃ¶sung:**
```powershell
# Firewall-Regel hinzufÃ¼gen (als Admin in PowerShell)
netsh advfirewall firewall add rule name="Mosquitto MQTT" dir=in action=allow protocol=tcp localport=1883

# Mosquitto Config prÃ¼fen (C:\Program Files\mosquitto\mosquitto.conf):
# Am Ende sollte stehen:
# allow_anonymous true
# listener 1883
```

**Nach Ã„nderung:** Mosquitto neu starten:
```powershell
net stop mosquitto
net start mosquitto
```

### 6.2 VS Code Wokwi Extension - Netzwerk funktioniert nicht

**Problem:** MQTT-Verbindung schlÃ¤gt fehl obwohl `gateway = true` gesetzt ist.

**Ursache:** VS Code Wokwi Extension hat eingeschrÃ¤nkten Netzwerk-Support.

**LÃ¶sung:** Wokwi CLI verwenden statt VS Code Extension:
```powershell
C:\Users\PCUser\.wokwi\bin\wokwi-cli.exe . --timeout 0
```

### 6.3 DNS Failed for (empty)

**Symptom:**
```
[E][WiFiGeneric.cpp:1583] hostByName(): DNS Failed for
```

**Ursache:** Hostname wird nach erstem Verbindungsversuch nicht mehr korrekt aufgelÃ¶st (mÃ¶glicher Bug).

**Workaround:** Wokwi CLI neu starten oder direkte IP verwenden.

### 6.4 ESP_00000001 nicht in Server-Datenbank

**Problem:** Server loggt "Unknown ESP" oder ignoriert Heartbeats.

**LÃ¶sung:**
```powershell
cd "c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\El Servador\god_kaiser_server"
poetry run python scripts/seed_wokwi_esp.py
```

### 6.5 kaiser_id leer â†’ Topics fehlerhaft (BEREITS GEFIXT)

**Problem:** MQTT-Topics enthielten `kaiser//esp/...` statt `kaiser/god/esp/...`

**Fix:** In `system_types.h` wurde Default-Wert geÃ¤ndert:
```cpp
String kaiser_id = "god";  // War vorher ""
```

### 6.6 WOKWI_CLI_TOKEN nicht erkannt

**Symptom:**
```
Error: Missing WOKWI_CLI_TOKEN environment variable
```

**LÃ¶sung:** Token ist als User-Variable gesetzt, aber neues Terminal sieht es noch nicht.
```powershell
# Direkt im Befehl setzen:
$env:WOKWI_CLI_TOKEN='wok_F9PGu0KSKMTupAZUUzEf6vFHyenjcYI420b4b725'

# Oder Batch-Script nutzen:
c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\scripts\run-wokwi.bat
```

---

## 7. Entwicklungs-Workflow

### 7.1 VollstÃ¤ndiger Test-Zyklus

```powershell
# Terminal 1: Server starten
cd "c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\El Servador\god_kaiser_server"
poetry run uvicorn god_kaiser_server.src.main:app --reload

# Terminal 2: MQTT Monitor starten
mosquitto_sub -h localhost -p 1883 -t "kaiser/#" -v

# Terminal 3: Firmware bauen
cd "c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\El Trabajante"
~/.platformio/penv/Scripts/platformio.exe run -e wokwi_simulation

# Terminal 4: Wokwi CLI starten
$env:WOKWI_CLI_TOKEN='wok_F9PGu0KSKMTupAZUUzEf6vFHyenjcYI420b4b725'
C:\Users\PCUser\.wokwi\bin\wokwi-cli.exe . --timeout 0

# Beobachten:
# - Terminal 2: Erscheinen Heartbeat-Nachrichten?
# - Terminal 1: Loggt Server die Heartbeats?
```

### 7.2 Nur ESP32 Serial Output beobachten

```powershell
# RFC2217 Serial Port verbinden (wenn Wokwi lÃ¤uft)
cd "c:\Users\PCUser\Documents\PlatformIO\Projects\Auto-one\El Trabajante"
python scripts/wokwi_serial_logger.py

# Output erscheint in:
# - Terminal (live)
# - logs/wokwi_serial.log (persistent)
```

---

## 8. CI/CD Pipeline

### 8.1 GitHub Actions Workflows

| Workflow | Datei | Trigger |
|----------|-------|---------|
| Wokwi Tests | `.github/workflows/wokwi-tests.yml` | Push zu `El Trabajante/**` |
| ESP32 Tests | `.github/workflows/esp32-tests.yml` | Push zu `tests/esp32/**` |
| Server Tests | `.github/workflows/server-tests.yml` | Push zu `El Servador/**` |

### 8.2 GitHub CLI fÃ¼r Workflow-Logs

```powershell
# Workflows auflisten
gh workflow list

# Runs eines Workflows
gh run list --workflow=wokwi-tests.yml

# Logs abrufen
gh run view <run-id> --log
gh run view <run-id> --log-failed

# Workflow manuell triggern
gh workflow run wokwi-tests.yml

# Artifacts herunterladen
gh run download <run-id>
```

### 8.3 Wokwi CI Token (GitHub Secret)

```
Name: WOKWI_CLI_TOKEN
Value: wok_F9PGu0KSKMTupAZUUzEf6vFHyenjcYI420b4b725
```

**Konfigurieren:** GitHub Repo â†’ Settings â†’ Secrets â†’ Actions â†’ New repository secret

---

## 9. Referenzen - Weitere Dokumentation

| Dokument | Pfad | Inhalt |
|----------|------|--------|
| **CLAUDE.md** | `.claude/CLAUDE.md` | Haupt-KI-Dokumentation, ESP32-Architektur |
| **CLAUDE_SERVER.md** | `.claude/CLAUDE_SERVER.md` | Server-spezifisch, MQTT-Handler |
| **CLAUDE_FRONTEND.md** | `.claude/CLAUDE_FRONTEND.md` | Frontend-spezifisch, Vue.js |
| **Mqtt_Protocoll.md** | `El Trabajante/docs/Mqtt_Protocoll.md` | MQTT-Spezifikation, Topic-Struktur |
| **Bugs_Found.md** | `.claude/Next Steps/Bugs_Found.md` | Gefixte Bugs (4 dokumentiert) |
| **DEBUG_ARCHITECTURE.md** | `El Frontend/Docs/DEBUG_ARCHITECTURE.md` | Debug-Anleitung, Service-Start |
| **API_REFERENCE.md** | `El Trabajante/docs/API_REFERENCE.md` | ESP32 API-Dokumentation |

---

## 10. Aktueller Status (2026-01-06)

### âœ… ALLES FUNKTIONIERT!

- [x] Firmware baut erfolgreich fÃ¼r `wokwi_simulation`
- [x] Wokwi CLI ist installiert (`C:\Users\PCUser\.wokwi\bin\wokwi-cli.exe`)
- [x] WOKWI_CLI_TOKEN ist permanent als User-Variable gesetzt
- [x] Batch-Script `scripts/run-wokwi.bat` erstellt
- [x] ESP32 bootet in Wokwi und verbindet sich zu WiFi (10.13.37.2)
- [x] NTP-Sync funktioniert
- [x] `kaiser_id` ist korrekt auf "god" gesetzt (system_types.h)
- [x] MQTT-Topics werden korrekt generiert
- [x] RFC2217 Serial Port (4000) fÃ¼r externes Logging konfiguriert
- [x] Serial Logger Script erstellt
- [x] **Windows Firewall-Regel fÃ¼r Port 1883 hinzugefÃ¼gt**
- [x] **MQTT-Verbindung von Wokwi zu lokalem Mosquitto funktioniert!**
- [x] **ESP_00000001 Heartbeats werden empfangen**

### GelÃ¶stes Problem: MQTT "Connection reset by peer"

**Ursache:** Windows Firewall blockierte eingehende Verbindungen auf Port 1883.

**LÃ¶sung (als Administrator):**
```powershell
netsh advfirewall firewall add rule name="Mosquitto MQTT" dir=in action=allow protocol=tcp localport=1883
net stop mosquitto && net start mosquitto
```

### Verifiziert funktioniert:

```
# Wokwi Serial Output:
[     14379] [INFO    ] MQTT connected!
[     14380] [INFO    ] Initial heartbeat sent for ESP registration

# MQTT Monitor Output:
kaiser/god/esp/ESP_00000001/system/heartbeat {"esp_id":"ESP_00000001","heap_free":212668,"wifi_rssi":-76,...}
kaiser/god/esp/ESP_00000001/system/diagnostics {"esp_id":"ESP_00000001","mqtt_connected":true,...}
```

---

## 11. Architektur-Diagramm

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ENTWICKLUNGSUMGEBUNG                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ Mosquitto        â”‚     â”‚ God-Kaiser Server â”‚                    â”‚
â”‚  â”‚ Port 1883        â”‚â—„â”€â”€â”€â–ºâ”‚ Port 8000         â”‚                    â”‚
â”‚  â”‚ (Windows Service)â”‚     â”‚ (Python/FastAPI)  â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚           â”‚ MQTT                    â”‚ REST/WS                       â”‚
â”‚           â”‚                         â”‚                               â”‚
â”‚           â–¼                         â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ Wokwi CLI        â”‚     â”‚ Frontend (Vue.js) â”‚                    â”‚
â”‚  â”‚ ESP_00000001     â”‚     â”‚ Port 5173         â”‚                    â”‚
â”‚  â”‚ IP: 10.13.37.2   â”‚     â”‚                   â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                     â”‚
â”‚  Verbindungs-Flow:                                                  â”‚
â”‚  1. Wokwi-ESP verbindet zu host.wokwi.internal:1883                â”‚
â”‚  2. Wokwi Gateway routet zu localhost:1883 (Mosquitto)             â”‚
â”‚  3. ESP sendet Heartbeat auf kaiser/god/esp/ESP_00000001/...       â”‚
â”‚  4. Server empfÃ¤ngt via MQTT-Handler                               â”‚
â”‚  5. Frontend zeigt ESP_00000001 als "online"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. Dateien-Ãœbersicht (Erstellte/Modifizierte)

```
Auto-one/
â”œâ”€â”€ .github/workflows/
â”‚   â””â”€â”€ wokwi-tests.yml              # GitHub Actions Workflow
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ run-wokwi.bat                # Batch-Script fÃ¼r Wokwi CLI
â”œâ”€â”€ El Trabajante/
â”‚   â”œâ”€â”€ wokwi.toml                   # Wokwi CLI Konfiguration
â”‚   â”œâ”€â”€ diagram.json                 # Virtuelles Hardware-Diagramm
â”‚   â”œâ”€â”€ platformio.ini               # [env:wokwi_simulation] Environment
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â””â”€â”€ wokwi_serial_logger.py   # RFC2217 Serial Logger
â”‚   â”œâ”€â”€ logs/
â”‚   â”‚   â””â”€â”€ wokwi_serial.log         # Serial Output Logs
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â””â”€â”€ system_types.h       # kaiser_id = "god" (gefixt)
â”‚   â”‚   â””â”€â”€ services/config/
â”‚   â”‚       â””â”€â”€ config_manager.cpp   # WOKWI_SIMULATION Fallback
â”‚   â””â”€â”€ tests/wokwi/
â”‚       â”œâ”€â”€ README.md                # Test-Dokumentation
â”‚       â”œâ”€â”€ boot_test.yaml           # Boot-Sequenz Szenario
â”‚       â””â”€â”€ mqtt_connection.yaml     # MQTT-Test Szenario
â”œâ”€â”€ El Servador/god_kaiser_server/
â”‚   â””â”€â”€ scripts/
â”‚       â””â”€â”€ seed_wokwi_esp.py        # ESP_00000001 in DB erstellen
â””â”€â”€ .claude/Next Steps/
    â”œâ”€â”€ 1.Wokwiki.md                 # Dieses Dokument
    â””â”€â”€ Bugs_Found.md                # Bug-Dokumentation
```

---

## 13. Bekannte Bugs & Fixes

> **VollstÃ¤ndige Bug-Dokumentation:** `.claude/Next Steps/Bugs_Found.md`

### KurzÃ¼bersicht

| Bug | Status | Beschreibung | Fix |
|-----|--------|--------------|-----|
| **Bug R** | âœ… GEFIXT | Timezone-Anzeige 1h falsch | `normalizeTimestamp()` in formatters.ts |
| **Bug S** | âœ… GEFIXT | ESP_WOKWI001 ungÃ¼ltig | Aus DB gelÃ¶scht, korrekt: ESP_00000001 |
| **Bug T** | âš ï¸ BEKANNT | MQTT nach Standby | Wokwi neu starten |

### Quick-Fixes

**Bug R (Timezone):** Bereits gefixt in `El Frontend/src/utils/formatters.ts`

**Bug S (ESP ID):** Falls 500-Fehler auftritt:
```powershell
# UngÃ¼ltige ESPs in DB finden
cd "El Servador/god_kaiser_server"
poetry run python -c "
import asyncio
from src.db.session import get_session_maker
from sqlalchemy import text
async def check():
    async with get_session_maker()() as s:
        r = await s.execute(text('SELECT device_id FROM esp_devices'))
        for row in r.fetchall():
            print(row[0])
asyncio.run(check())
"
```

**Bug T (Standby):** Wokwi-Simulation beenden und neu starten.

---

## 14. VollstÃ¤ndiger Entwicklungs-Workflow

### Schritt-fÃ¼r-Schritt: Wokwi Development Setup

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ENTWICKLUNGS-WORKFLOW                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  KI-AGENT (automatisch):                                        â”‚
â”‚  ========================                                        â”‚
â”‚  1. âœ… Mosquitto prÃ¼fen        â†’ netstat -ano | findstr 1883    â”‚
â”‚  2. âœ… Server starten          â†’ poetry run uvicorn ...         â”‚
â”‚  3. âœ… Frontend starten        â†’ npm run dev                    â”‚
â”‚  4. âœ… ESP registrieren        â†’ poetry run python scripts/...  â”‚
â”‚  5. âœ… Dem User Bescheid geben                                  â”‚
â”‚                                                                 â”‚
â”‚  USER (manuell):                                                â”‚
â”‚  ===============                                                 â”‚
â”‚  6. ğŸ”§ Firmware bauen          â†’ pio run -e wokwi_simulation    â”‚
â”‚  7. ğŸš€ Wokwi starten          â†’ VS Code Extension / CLI         â”‚
â”‚  8. ğŸ‘€ Frontend Ã¶ffnen        â†’ http://localhost:5173           â”‚
â”‚  9. âœ“  ESP_00000001 sehen     â†’ Dashboard oder Device-Liste    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Access Points (wenn alles lÃ¤uft)

| Service | URL | Login |
|---------|-----|-------|
| **Frontend** | http://localhost:5173 | test_admin / TestAdmin123! |
| **API Docs** | http://localhost:8000/docs | - |
| **API Health** | http://localhost:8000/api/v1/health | - |

### Log-Monitoring Befehle

```powershell
# Server-Logs (live)
Get-Content "El Servador\god_kaiser_server\logs\god_kaiser.log" -Wait -Tail 20

# MQTT Traffic (alle Topics)
mosquitto_sub -h localhost -t "kaiser/#" -v

# MQTT (nur ESP_00000001)
mosquitto_sub -h localhost -t "kaiser/god/esp/ESP_00000001/#" -v

# Server-Logs nach Fehlern filtern
Select-String -Path "El Servador\god_kaiser_server\logs\god_kaiser.log" -Pattern "ERROR"
```

---

**Dokument-Version:** 4.0
**Erstellt:** 2026-01-05
**Aktualisiert:** 2026-01-06
**Autor:** Claude (Opus 4.5)
**Status:** âœ… VOLLSTÃ„NDIG FUNKTIONSFÃ„HIG - Wokwi ESP32 â†’ MQTT â†’ Mosquitto â†’ Server
