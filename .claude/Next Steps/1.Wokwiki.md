# DEV-BRIEFING 01: Wokwi ESP32-Virtualisierung

> **Ziel:** Echte ESP32-Firmware in virtueller Umgebung testen, die sich wie reale Hardware verhält und mit dem echten MQTT-Broker kommuniziert.
> **Priorität:** KRITISCH - Ermöglicht Hardware-Tests ohne physische Geräte
> **Geschätzter Aufwand:** 3-5 Entwicklertage
> **Status:** IMPLEMENTIERT (2026-01-05)

---

## IMPLEMENTIERUNGSSTATUS

| Komponente | Status | Datei |
|------------|--------|-------|
| `wokwi.toml` | ERSTELLT | `El Trabajante/wokwi.toml` |
| `diagram.json` | ERSTELLT | `El Trabajante/diagram.json` |
| `platformio.ini` Wokwi-Environment | ERSTELLT | `El Trabajante/platformio.ini` ([env:wokwi_simulation]) |
| Compile-Time Credentials | IMPLEMENTIERT | `El Trabajante/src/services/config/config_manager.cpp` |
| GitHub Actions Workflow | ERSTELLT | `.github/workflows/wokwi-tests.yml` |
| Boot Test Scenario | ERSTELLT | `El Trabajante/tests/wokwi/boot_test.yaml` |
| MQTT Test Scenario | ERSTELLT | `El Trabajante/tests/wokwi/mqtt_connection.yaml` |
| Test README | ERSTELLT | `El Trabajante/tests/wokwi/README.md` |

---

## 1. Problemstellung

### 1.1 Aktuelle Situation

Das System hat bereits **Mock-ESPs** (serverseitige Simulation), die MQTT-Nachrichten generieren. Diese sind jedoch **keine echte Firmware-Simulation**:

- Mock-ESPs simulieren nur das Server-Verhalten (Python)
- Die tatsächliche ESP32-Firmware (`El Trabajante`) wird nicht getestet
- Firmware-Bugs (C++, GPIO, NVS, WiFi-Reconnect) werden nicht erkannt
- CI-Pipeline testet nur Server-Code, nicht ESP32-Code

### 1.2 Gewünschter Zustand

**Wokwi-Integration** ermöglicht:
- Echte ESP32-Firmware (`El Trabajante`) läuft in virtueller Umgebung
- Wokwi-ESP verbindet sich mit dem echten MQTT-Broker
- Kompletter Kommunikationsflow wird getestet (ESP ↔ MQTT ↔ Server)
- CI-Pipeline kann Firmware-Tests automatisiert ausführen
- Lokale Entwicklung ohne Hardware möglich

---

## 2. Systemverständnis (PFLICHTLEKTÜRE)

**Bevor du Code schreibst, lies diese Dokumentation:**

| Dokument | Pfad | Relevanz |
|----------|------|----------|
| **CLAUDE.md** | `.claude/CLAUDE.md` | ESP32-Firmware-Architektur, Build-Commands |
| **CLAUDE_SERVER.md** | `.claude/CLAUDE_SERVER.md` | Server-Architektur, MQTT-Handler |
| **Hierarchie.md** | `Hierarchie.md` | 4-Layer-System, Kommunikationsflüsse |
| **MQTT-Protokoll** | `El Trabajante/docs/Mqtt_Protocoll.md` | Topic-Struktur, Payload-Formate |
| **System-Flows** | `El Trabajante/docs/system-flows/` | Boot, Sensor, Actuator Flows |

### 2.1 Architektur-Kontext

```
┌─────────────────────────────────────────────────────────────────────┐
│                     AKTUELL (Mock-ESPs)                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────┐     ┌─────────────────┐                       │
│  │  Mock-ESP       │     │   Server        │                       │
│  │  (Python)       │────▶│   (Python)      │                       │
│  │  simuliert MQTT │     │   empfängt MQTT │                       │
│  └─────────────────┘     └─────────────────┘                       │
│                                                                     │
│  Problem: Firmware (C++) wird NICHT getestet                        │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                     ZIEL (Wokwi-Integration)                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────┐     ┌─────────────────┐    ┌───────────────┐  │
│  │  Wokwi-ESP      │     │   MQTT Broker   │    │    Server     │  │
│  │  (echte C++     │────▶│   (Mosquitto)   │───▶│   (Python)    │  │
│  │   Firmware!)    │◀────│                 │◀───│               │  │
│  └─────────────────┘     └─────────────────┘    └───────────────┘  │
│                                                                     │
│  Vorteil: Kompletter Stack wird getestet                           │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. Codebase-Analyse (PHASE 1)

### 3.1 ESP32-Firmware analysieren

**Verzeichnis:** `El Trabajante/`

**Kritische Dateien für Wokwi-Kompatibilität:**

| Datei | Pfad | Prüfen auf |
|-------|------|------------|
| `platformio.ini` | `El Trabajante/platformio.ini` | Build-Environments, Libs |
| `main.cpp` | `El Trabajante/src/main.cpp` | Boot-Sequenz, WiFi-Init |
| `mqtt_client.cpp` | `El Trabajante/src/services/communication/mqtt_client.cpp` | MQTT-Verbindung |
| `wifi_manager.cpp` | `El Trabajante/src/services/communication/wifi_manager.cpp` | WiFi-Konfiguration |
| `config_manager.cpp` | `El Trabajante/src/services/config/config_manager.cpp` | NVS-Zugriff |
| `sensor_manager.cpp` | `El Trabajante/src/services/sensor/sensor_manager.cpp` | Sensor-Initialisierung |
| `actuator_manager.cpp` | `El Trabajante/src/services/actuator/actuator_manager.cpp` | Actuator-Steuerung |

**Fragen für die Analyse:**

1. **WiFi-Konfiguration:** Wie werden SSID/Password aktuell gesetzt?
   - NVS-Namespace: `wifi_config`
   - Keys: `ssid`, `password`
   - Fallback: AP-Mode für Provisioning

2. **MQTT-Konfiguration:** Wie wird der Broker konfiguriert?
   - NVS-Namespace: `mqtt_config`
   - Keys: `broker_host`, `broker_port`, `username`, `password`

3. **Hardware-Abstraction:** Welche GPIOs werden verwendet?
   - Board-Configs: `El Trabajante/src/config/hardware/`
   - I2C, SPI, OneWire Pins

### 3.2 Wokwi-Spezifische Anforderungen

**Wokwi unterstützt:**
- ESP32-WROOM-DevKit
- GPIO, I2C, SPI, OneWire
- WiFi (simuliert, verbindet sich mit externem Netzwerk via `wokwi-gateway`)
- MQTT (über WiFi)
- NVS (persistenter Speicher simuliert)

**Wokwi unterstützt NICHT:**
- Bluetooth (teilweise)
- Spezielle Hardware-Features einiger Sensoren

### 3.3 Server-Seite analysieren

**Mock-ESP-System (zum Vergleich):**

| Datei | Pfad | Funktion |
|-------|------|----------|
| `mock_esp_manager.py` | `El Servador/god_kaiser_server/src/services/mock_esp_manager.py` | Mock-ESP-Verwaltung |
| `mock_esp32_client.py` | `El Servador/god_kaiser_server/src/mqtt/mock_esp32_client.py` | MQTT-Simulation |
| `debug.py` | `El Servador/god_kaiser_server/src/api/v1/debug.py` | Debug-API |

**Relevante Endpoints:**
- `POST /v1/debug/mock-esp` - Mock-ESP erstellen
- `GET /v1/debug/mock-esp` - Alle Mock-ESPs auflisten

---

## 4. Wokwi-Integration (PHASE 2)

### 4.1 Wokwi-Dateien erstellen

**Erforderliche Dateien im Projekt:**

```
El Trabajante/
├── wokwi.toml              # Wokwi-Konfiguration
├── diagram.json            # Hardware-Diagramm
└── .wokwi-credentials.toml # WiFi/MQTT-Credentials (lokal, nicht committen!)
```

**wokwi.toml** IMPLEMENTIERT in `El Trabajante/wokwi.toml`:
```toml
[wokwi]
version = 1
firmware = ".pio/build/wokwi_simulation/firmware.bin"
elf = ".pio/build/wokwi_simulation/firmware.elf"

# Gateway für externe Netzwerk-Verbindung
[wokwi.network]
gateway = true

[wokwi.serial]
baud = 115200
```

**diagram.json Beispiel:**
```json
{
  "version": 1,
  "author": "AutomationOne",
  "editor": "wokwi",
  "parts": [
    {
      "type": "wokwi-esp32-devkit-v1",
      "id": "esp",
      "top": 0,
      "left": 0,
      "attrs": {}
    },
    {
      "type": "wokwi-dht22",
      "id": "dht1",
      "top": 100,
      "left": 100,
      "attrs": {}
    }
  ],
  "connections": [
    ["esp:GND.1", "dht1:GND", "black", []],
    ["esp:3V3", "dht1:VCC", "red", []],
    ["esp:D4", "dht1:SDA", "green", []]
  ]
}
```

### 4.2 WiFi/MQTT für Wokwi konfigurieren

**Problem:** Wokwi braucht Credentials, die NICHT in NVS gespeichert sind (da Wokwi keinen persistenten NVS-Speicher zwischen Sessions hat).

**Lösung: Compile-Time Credentials für Wokwi-Build**

IMPLEMENTIERT in `El Trabajante/platformio.ini`:

```ini
[env:wokwi_simulation]
extends = env:esp32_dev
build_flags =
    ${env:esp32_dev.build_flags}
    ; Wokwi Simulation Mode
    -D WOKWI_SIMULATION=1
    ; WiFi credentials for Wokwi (Wokwi-GUEST is open network)
    -D WOKWI_WIFI_SSID=\"Wokwi-GUEST\"
    -D WOKWI_WIFI_PASSWORD=\"\"
    ; MQTT broker via Wokwi Gateway (routes to localhost or CI service)
    -D WOKWI_MQTT_HOST=\"host.wokwi.internal\"
    -D WOKWI_MQTT_PORT=1883
    ; Optional: Pre-configured ESP ID for reproducible tests
    -D WOKWI_ESP_ID=\"ESP_WOKWI001\"
```

IMPLEMENTIERT in `El Trabajante/src/services/config/config_manager.cpp`:

**loadWiFiConfig()** (Zeilen 61-137):
```cpp
#ifdef WOKWI_SIMULATION
    LOG_INFO("ConfigManager: WOKWI_SIMULATION mode - using compile-time credentials");

    #ifdef WOKWI_WIFI_SSID
      config.ssid = WOKWI_WIFI_SSID;
    #else
      config.ssid = "Wokwi-GUEST";
    #endif

    #ifdef WOKWI_MQTT_HOST
      config.server_address = WOKWI_MQTT_HOST;
    #else
      config.server_address = "host.wokwi.internal";
    #endif

    #ifdef WOKWI_MQTT_PORT
      config.mqtt_port = WOKWI_MQTT_PORT;
    #else
      config.mqtt_port = 1883;
    #endif

    config.configured = true;
    return true;
#endif

// NORMAL MODE: Load from NVS
// ... (original NVS code)
```

**generateESPIdIfMissing()** (Zeilen 721-756):
```cpp
#ifdef WOKWI_SIMULATION
  #ifdef WOKWI_ESP_ID
    system_config_.esp_id = WOKWI_ESP_ID;
    LOG_INFO("ConfigManager: Using Wokwi ESP ID: " + system_config_.esp_id);
  #else
    system_config_.esp_id = "ESP_WOKWI001";
  #endif
  saveSystemConfig(system_config_);
  return;
#endif
// NORMAL MODE: Generate from MAC address
```

### 4.3 Wokwi Gateway für MQTT

**Wokwi Gateway** ermöglicht Verbindung zu externem MQTT-Broker:

1. **Lokaler Test:** `host.wokwi.internal` routet zu `localhost`
2. **CI-Test:** Mosquitto als Service im CI-Runner

**MQTT-Broker im CI:**
```yaml
# .github/workflows/wokwi-tests.yml
services:
  mosquitto:
    image: eclipse-mosquitto:2
    ports:
      - 1883:1883
    options: >-
      --health-cmd "mosquitto_sub -t test -C 1 -W 1 || exit 1"
      --health-interval 10s
```

---

## 5. CI-Integration (PHASE 3)

### 5.1 Wokwi CI Setup

**Wokwi CI verwendet `wokwi-cli`:**

```yaml
# .github/workflows/wokwi-tests.yml
name: Wokwi ESP32 Tests

on:
  push:
    paths:
      - 'El Trabajante/**'
  pull_request:
    paths:
      - 'El Trabajante/**'

jobs:
  wokwi-test:
    runs-on: ubuntu-latest
    
    services:
      mosquitto:
        image: eclipse-mosquitto:2
        ports:
          - 1883:1883
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install PlatformIO
        run: pip install platformio
      
      - name: Build Wokwi Firmware
        run: |
          cd "El Trabajante"
          pio run -e wokwi_simulation
      
      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH
      
      - name: Run Wokwi Simulation
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          cd "El Trabajante"
          wokwi-cli run --timeout 60000 --scenario tests/wokwi/boot_test.yaml
```

### 5.2 Test-Szenarien definieren

**Test-Szenario-Dateien:**

```
El Trabajante/
└── tests/
    └── wokwi/
        ├── boot_test.yaml          # Boot-Sequenz testen
        ├── mqtt_connection.yaml    # MQTT-Verbindung testen
        ├── sensor_publish.yaml     # Sensor-Daten publizieren
        └── actuator_command.yaml   # Actuator-Commands empfangen
```

**boot_test.yaml Beispiel:**
```yaml
name: Boot Sequence Test
steps:
  - wait-serial: "Phase 0: System Initialization"
    timeout: 10000
  - wait-serial: "Phase 1: Configuration READY"
    timeout: 5000
  - wait-serial: "Phase 2: Network READY"
    timeout: 30000
  - wait-serial: "Phase 3: Hardware Abstraction READY"
    timeout: 5000
  - wait-serial: "MQTT connected"
    timeout: 10000
  - wait-serial: "Heartbeat published"
    timeout: 65000
```

---

## 6. Implementierungs-Checkliste

### Phase 1: Codebase-Analyse (Tag 1) - ABGESCHLOSSEN

- [x] ESP32-Firmware auf Wokwi-Kompatibilität prüfen
- [x] WiFi/MQTT-Konfiguration analysieren
- [x] Hardware-Abstraction-Layer prüfen
- [x] Board-spezifische GPIOs dokumentieren

**Analyse-Ergebnisse:**
- Board: ESP32-WROOM-32 (Wokwi: `wokwi-esp32-devkit-v1`)
- I2C: SDA=21, SCL=22
- OneWire: GPIO 4
- Reserved Pins: 0, 1, 2, 3, 12, 13
- WiFi-Credentials: über ConfigManager aus NVS geladen
- MQTT: WiFiConfig.server_address + mqtt_port

### Phase 2: Wokwi-Konfiguration (Tag 1-2) - ABGESCHLOSSEN

- [x] `wokwi.toml` erstellen - `El Trabajante/wokwi.toml`
- [x] `diagram.json` für ESP32-DevKit erstellen - `El Trabajante/diagram.json`
- [x] `platformio.ini` um Wokwi-Environment erweitern - `[env:wokwi_simulation]`
- [x] Compile-Time Credentials implementieren - `config_manager.cpp`
- [ ] Lokalen Test durchführen - **AUSSTEHEND (Wokwi CLI Token benötigt)**

### Phase 3: CI-Integration (Tag 2-3) - ABGESCHLOSSEN

- [x] GitHub Actions Workflow erstellen - `.github/workflows/wokwi-tests.yml`
- [ ] Wokwi CLI Token als Secret konfigurieren - **AUSSTEHEND (GitHub Secrets)**
- [x] Mosquitto-Service im CI einrichten - Im Workflow als Service definiert
- [x] Test-Szenarien schreiben:
  - `El Trabajante/tests/wokwi/boot_test.yaml`
  - `El Trabajante/tests/wokwi/mqtt_connection.yaml`

### Phase 4: Validierung (Tag 3-4) - AUSSTEHEND

- [ ] Boot-Sequenz testen
- [ ] MQTT-Verbindung verifizieren
- [ ] Sensor-Publishing testen
- [ ] Actuator-Commands testen
- [ ] Server-Integration verifizieren

### Phase 5: Dokumentation (Tag 4-5) - TEILWEISE ABGESCHLOSSEN

- [x] README für Wokwi-Tests - `El Trabajante/tests/wokwi/README.md`
- [ ] CI-Status-Badges hinzufügen
- [ ] Troubleshooting-Guide

---

## 7. Wichtige Hinweise

### 7.1 Mock-ESP vs. Wokwi-ESP

| Aspekt | Mock-ESP (Python) | Wokwi-ESP (C++) |
|--------|-------------------|-----------------|
| **Firmware** | Simuliert | Echte Firmware |
| **MQTT** | Server-seitig | ESP-seitig |
| **GPIO** | Nicht getestet | Getestet |
| **NVS** | Nicht getestet | Getestet |
| **WiFi-Reconnect** | Nicht getestet | Getestet |
| **Memory-Leaks** | Nicht erkennbar | Erkennbar |
| **Timing** | Approximiert | Realistisch |

### 7.2 Koexistenz

Mock-ESPs und Wokwi-ESPs können **parallel** existieren:
- Mock-ESPs: Schnelle Server-Tests, Load-Tests
- Wokwi-ESPs: Firmware-Validierung, Integration-Tests

### 7.3 Wokwi-Limitierungen

- Kostenpflichtig für CI (aber Budget vorhanden)
- Nicht alle Sensoren unterstützt
- Netzwerk-Latenz simuliert, aber nicht identisch

---

## 8. Referenz-Links

- [Wokwi Dokumentation](https://docs.wokwi.com/)
- [Wokwi CI](https://docs.wokwi.com/wokwi-ci/getting-started)
- [Wokwi ESP32 Simulation](https://docs.wokwi.com/chips/esp32)
- [Wokwi Network Gateway](https://docs.wokwi.com/guides/esp32-wifi)

---

## 9. Nächste Schritte (TODO)

### Sofort (vor Nutzung):

1. **Wokwi CLI Token konfigurieren:**
   - Besuche https://wokwi.com/dashboard/ci
   - Erstelle neuen Token
   - In GitHub: Settings → Secrets → Actions → `WOKWI_CLI_TOKEN` hinzufügen

2. **Build verifizieren:**
   ```bash
   cd "El Trabajante"
   pio run -e wokwi_simulation
   ```

3. **Lokalen Test ausführen (optional):**
   ```bash
   # Wokwi CLI installieren
   curl -L https://wokwi.com/ci/install.sh | sh
   export PATH="$HOME/.wokwi/bin:$PATH"
   export WOKWI_CLI_TOKEN="your_token"

   # Test ausführen
   cd "El Trabajante"
   wokwi-cli run --timeout 90000
   ```

### Optional (Erweiterungen):

- [ ] Sensor-Publishing Test-Szenario hinzufügen
- [ ] Actuator-Command Test-Szenario hinzufügen
- [ ] CI-Status-Badge in README.md hinzufügen
- [ ] Mehr virtuelle Sensoren in `diagram.json` hinzufügen

---

## 10. Erstellte Dateien (Übersicht)

```
Auto-one/
├── .github/workflows/
│   └── wokwi-tests.yml           # GitHub Actions Workflow
├── El Trabajante/
│   ├── wokwi.toml                # Wokwi CLI Konfiguration
│   ├── diagram.json              # Virtuelles Hardware-Diagramm
│   ├── platformio.ini            # [env:wokwi_simulation] hinzugefügt
│   ├── src/services/config/
│   │   └── config_manager.cpp    # WOKWI_SIMULATION Fallback implementiert
│   └── tests/wokwi/
│       ├── README.md             # Dokumentation
│       ├── boot_test.yaml        # Boot-Sequenz Test
│       └── mqtt_connection.yaml  # MQTT-Verbindungs-Test
└── .claude/Next Steps/
    └── 1.Wokwiki.md              # Dieses Dokument (aktualisiert)
```

---

**Dokument-Version:** 2.0
**Erstellt:** 2026-01-05
**Implementiert:** 2026-01-05
**Autor:** Claude (Opus 4.5)
**Status:** Implementierung abgeschlossen, Validierung ausstehend