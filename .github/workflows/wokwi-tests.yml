# ============================================
# Wokwi ESP32 Firmware Tests
# ============================================
# Purpose: Test real ESP32 firmware in Wokwi virtual environment
#
# This workflow:
# 1. Starts Mosquitto MQTT broker (anonymous access enabled)
# 2. Builds the ESP32 firmware with Wokwi-specific configuration
# 3. Runs the firmware in Wokwi simulator
# 4. Validates boot sequence, WiFi, MQTT, sensors, actuators, zones
#
# Prerequisites:
# - WOKWI_CLI_TOKEN secret must be configured in GitHub repository
#
# Test Categories (15 scenarios total):
# - Boot Tests (passive): boot_full, boot_safe_mode
# - Sensor Tests (passive): sensor_heartbeat, sensor_ds18b20_read
# - MQTT Connection (passive, legacy): mqtt_connection
# - Actuator Tests (MQTT injection): actuator_led_on, actuator_pwm, actuator_status_publish, actuator_emergency_clear
# - Zone Tests (MQTT injection): zone_assignment, subzone_assignment
# - Emergency Tests (MQTT injection): emergency_broadcast, emergency_esp_stop
# - Config Tests (MQTT injection): config_sensor_add, config_actuator_add
#
# Documentation: https://docs.wokwi.com/wokwi-ci/getting-started

name: Wokwi ESP32 Tests

on:
  push:
    paths:
      - 'El Trabajante/**'
      - '.github/workflows/wokwi-tests.yml'
  pull_request:
    paths:
      - 'El Trabajante/**'
      - '.github/workflows/wokwi-tests.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  # ============================================
  # JOB 1: Build Firmware (shared by all tests)
  # ============================================
  build-firmware:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          pip install platformio
          echo "PlatformIO version:"
          pio --version

      - name: Build Wokwi Firmware
        run: |
          cd "El Trabajante"
          pio run -e wokwi_simulation
          echo "Firmware built successfully"

      - name: Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/
          retention-days: 1

  # ============================================
  # JOB 2: Boot & Core Tests
  # ============================================
  boot-tests:
    runs-on: ubuntu-latest
    needs: build-firmware
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/

      - name: Start Mosquitto MQTT Broker
        run: |
          mkdir -p /tmp/mosquitto
          cat > /tmp/mosquitto/mosquitto.conf << 'EOF'
          listener 1883 0.0.0.0
          allow_anonymous true
          persistence false
          log_dest stderr
          log_type all
          connection_messages true
          EOF

          docker run -d \
            --name mosquitto \
            -p 1883:1883 \
            -v /tmp/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
            eclipse-mosquitto:2

          echo "Waiting for Mosquitto to start..."
          for i in {1..30}; do
            if docker exec mosquitto mosquitto_pub -t 'health/check' -m 'ping' 2>/dev/null; then
              echo "Mosquitto is ready!"
              break
            fi
            sleep 1
          done

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Run Boot Full Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/01-boot/boot_full.yaml \
            2>&1 | tee boot_full.log || true

          echo "=== Boot Full Test Results ==="
          grep -q "Phase 1: Core Infrastructure READY" boot_full.log && echo "Phase 1 OK" || echo "Phase 1 MISSING"
          grep -q "Phase 2: Communication Layer READY" boot_full.log && echo "Phase 2 OK" || echo "Phase 2 MISSING"
          grep -q "Phase 3: Hardware Abstraction READY" boot_full.log && echo "Phase 3 OK" || echo "Phase 3 MISSING"
          grep -q "Phase 4: Sensor System READY" boot_full.log && echo "Phase 4 OK" || echo "Phase 4 MISSING"
          grep -q "Phase 5: Actuator System READY" boot_full.log && echo "Phase 5 OK" || echo "Phase 5 MISSING"

      - name: Run Safe-Mode Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 60 wokwi-cli . \
            --timeout 45000 \
            --scenario tests/wokwi/scenarios/01-boot/boot_safe_mode.yaml \
            2>&1 | tee boot_safe_mode.log || true

          echo "=== Safe-Mode Test Results ==="
          grep -q "GPIO SAFE-MODE INITIALIZATION" boot_safe_mode.log && echo "Safe-Mode OK" || echo "Safe-Mode MISSING"

      - name: Stop Mosquitto
        if: always()
        run: docker stop mosquitto && docker rm mosquitto || true

      - name: Upload Boot Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: boot-test-logs
          path: El Trabajante/*.log
          retention-days: 7

  # ============================================
  # JOB 3: Sensor & Heartbeat Tests
  # ============================================
  sensor-tests:
    runs-on: ubuntu-latest
    needs: build-firmware
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/

      - name: Start Mosquitto MQTT Broker
        run: |
          mkdir -p /tmp/mosquitto
          echo -e "listener 1883 0.0.0.0\nallow_anonymous true" > /tmp/mosquitto/mosquitto.conf
          docker run -d --name mosquitto -p 1883:1883 \
            -v /tmp/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
            eclipse-mosquitto:2
          sleep 5

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Run Heartbeat Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/02-sensor/sensor_heartbeat.yaml \
            2>&1 | tee sensor_heartbeat.log || true

          echo "=== Heartbeat Test Results ==="
          grep -q "Initial heartbeat sent" sensor_heartbeat.log && echo "Heartbeat OK" || echo "Heartbeat MISSING"

      - name: Run DS18B20 Sensor Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/02-sensor/sensor_ds18b20_read.yaml \
            2>&1 | tee sensor_ds18b20.log || true

          echo "=== DS18B20 Test Results ==="
          grep -q "OneWire" sensor_ds18b20.log && echo "OneWire OK" || echo "OneWire MISSING"

      - name: Stop Mosquitto
        if: always()
        run: docker stop mosquitto && docker rm mosquitto || true

      - name: Upload Sensor Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sensor-test-logs
          path: El Trabajante/*.log
          retention-days: 7

  # ============================================
  # JOB 4: MQTT Connection Test (Legacy - kept for backward compatibility)
  # ============================================
  mqtt-connection-test:
    runs-on: ubuntu-latest
    needs: build-firmware
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/

      - name: Start Mosquitto MQTT Broker
        run: |
          mkdir -p /tmp/mosquitto
          echo -e "listener 1883 0.0.0.0\nallow_anonymous true\npersistence false" > /tmp/mosquitto/mosquitto.conf
          docker run -d --name mosquitto -p 1883:1883 \
            -v /tmp/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
            eclipse-mosquitto:2
          sleep 5

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Run MQTT Connection Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/mqtt_connection.yaml \
            2>&1 | tee wokwi_mqtt_output.log || true

          echo "=== MQTT Connection Test Results ==="
          grep -q "MQTT connected" wokwi_mqtt_output.log && echo "MQTT OK" || echo "MQTT MISSING"
          grep -q "heartbeat" wokwi_mqtt_output.log && echo "Heartbeat OK" || echo "Heartbeat MISSING"

      - name: Stop Mosquitto
        if: always()
        run: docker stop mosquitto && docker rm mosquitto || true

      - name: Upload MQTT Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mqtt-test-logs
          path: El Trabajante/*.log
          retention-days: 7

  # ============================================
  # JOB 5: Actuator Tests (MQTT Injection)
  # ============================================
  actuator-tests:
    runs-on: ubuntu-latest
    needs: build-firmware
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/

      - name: Start Mosquitto MQTT Broker
        run: |
          mkdir -p /tmp/mosquitto
          cat > /tmp/mosquitto/mosquitto.conf << 'CONF'
          listener 1883 0.0.0.0
          allow_anonymous true
          persistence false
          CONF
          docker run -d --name mosquitto -p 1883:1883 \
            -v /tmp/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
            eclipse-mosquitto:2
          for i in {1..30}; do
            docker exec mosquitto mosquitto_pub -t 'health/check' -m 'ping' 2>/dev/null && break
            sleep 1
          done

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Run LED ON Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/03-actuator/actuator_led_on.yaml \
            2>&1 | tee actuator_led_on.log &
          WOKWI_PID=$!
          sleep 25

          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/5/command" \
            -m '{"command":"ON","value":1.0}'

          wait $WOKWI_PID && echo "LED ON: PASS" || echo "LED ON: FAIL (exit $?)"

      - name: Run PWM Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/03-actuator/actuator_pwm.yaml \
            2>&1 | tee actuator_pwm.log &
          WOKWI_PID=$!
          sleep 25

          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/5/command" \
            -m '{"command":"PWM","value":0.5}'

          wait $WOKWI_PID && echo "PWM: PASS" || echo "PWM: FAIL (exit $?)"

      - name: Run Actuator Status Publish Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/03-actuator/actuator_status_publish.yaml \
            2>&1 | tee actuator_status.log || true

          echo "=== Actuator Status Test Results ==="
          grep -q "actuator" actuator_status.log && echo "Status Publish: PASS" || echo "Status Publish: FAIL"

      - name: Run Emergency Clear Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/03-actuator/actuator_emergency_clear.yaml \
            2>&1 | tee actuator_emergency_clear.log &
          WOKWI_PID=$!
          sleep 25

          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/emergency" \
            -m '{"command":"emergency_stop","auth_token":"ESP_00000001"}'

          wait $WOKWI_PID && echo "Emergency Clear: PASS" || echo "Emergency Clear: FAIL (exit $?)"

      - name: Stop Mosquitto
        if: always()
        run: docker stop mosquitto && docker rm mosquitto || true

      - name: Upload Actuator Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: actuator-test-logs
          path: El Trabajante/actuator_*.log
          retention-days: 7

  # ============================================
  # JOB 6: Zone Tests (MQTT Injection)
  # ============================================
  zone-tests:
    runs-on: ubuntu-latest
    needs: build-firmware
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/

      - name: Start Mosquitto MQTT Broker
        run: |
          mkdir -p /tmp/mosquitto
          cat > /tmp/mosquitto/mosquitto.conf << 'CONF'
          listener 1883 0.0.0.0
          allow_anonymous true
          persistence false
          CONF
          docker run -d --name mosquitto -p 1883:1883 \
            -v /tmp/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
            eclipse-mosquitto:2
          for i in {1..30}; do
            docker exec mosquitto mosquitto_pub -t 'health/check' -m 'ping' 2>/dev/null && break
            sleep 1
          done

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Run Zone Assignment Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/04-zone/zone_assignment.yaml \
            2>&1 | tee zone_assignment.log &
          WOKWI_PID=$!
          sleep 25

          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/zone/assign" \
            -m '{"zone_id":"test_zone_1","master_zone_id":"master_test","zone_name":"Test Zone","kaiser_id":"god"}'

          wait $WOKWI_PID && echo "Zone Assignment: PASS" || echo "Zone Assignment: FAIL (exit $?)"

      - name: Run Subzone Assignment Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/04-zone/subzone_assignment.yaml \
            2>&1 | tee subzone_assignment.log &
          WOKWI_PID=$!
          sleep 25

          # Assign zone first (prerequisite for subzone)
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/zone/assign" \
            -m '{"zone_id":"test_zone_1","master_zone_id":"master_test","zone_name":"Test Zone","kaiser_id":"god"}'
          sleep 3

          # Then assign subzone
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/subzone/assign" \
            -m '{"subzone_id":"subzone_1","subzone_name":"Subzone 1","parent_zone_id":"test_zone_1","assigned_gpios":[4,5]}'

          wait $WOKWI_PID && echo "Subzone Assignment: PASS" || echo "Subzone Assignment: FAIL (exit $?)"

      - name: Stop Mosquitto
        if: always()
        run: docker stop mosquitto && docker rm mosquitto || true

      - name: Upload Zone Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zone-test-logs
          path: El Trabajante/*_assignment.log
          retention-days: 7

  # ============================================
  # JOB 7: Emergency Tests (MQTT Injection)
  # ============================================
  emergency-tests:
    runs-on: ubuntu-latest
    needs: build-firmware
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/

      - name: Start Mosquitto MQTT Broker
        run: |
          mkdir -p /tmp/mosquitto
          cat > /tmp/mosquitto/mosquitto.conf << 'CONF'
          listener 1883 0.0.0.0
          allow_anonymous true
          persistence false
          CONF
          docker run -d --name mosquitto -p 1883:1883 \
            -v /tmp/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
            eclipse-mosquitto:2
          for i in {1..30}; do
            docker exec mosquitto mosquitto_pub -t 'health/check' -m 'ping' 2>/dev/null && break
            sleep 1
          done

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Run Broadcast Emergency Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/05-emergency/emergency_broadcast.yaml \
            2>&1 | tee emergency_broadcast.log &
          WOKWI_PID=$!
          sleep 25

          docker exec mosquitto mosquitto_pub \
            -t "kaiser/broadcast/emergency" \
            -m '{"auth_token":"master_token"}'

          wait $WOKWI_PID && echo "Broadcast Emergency: PASS" || echo "Broadcast Emergency: FAIL (exit $?)"

      - name: Run ESP Emergency Stop Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/05-emergency/emergency_esp_stop.yaml \
            2>&1 | tee emergency_esp_stop.log &
          WOKWI_PID=$!
          sleep 25

          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/emergency" \
            -m '{"command":"emergency_stop","auth_token":"ESP_00000001"}'

          wait $WOKWI_PID && echo "ESP Emergency: PASS" || echo "ESP Emergency: FAIL (exit $?)"

      - name: Stop Mosquitto
        if: always()
        run: docker stop mosquitto && docker rm mosquitto || true

      - name: Upload Emergency Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: emergency-test-logs
          path: El Trabajante/emergency_*.log
          retention-days: 7

  # ============================================
  # JOB 8: Config Tests (MQTT Injection)
  # ============================================
  config-tests:
    runs-on: ubuntu-latest
    needs: build-firmware
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/

      - name: Start Mosquitto MQTT Broker
        run: |
          mkdir -p /tmp/mosquitto
          cat > /tmp/mosquitto/mosquitto.conf << 'CONF'
          listener 1883 0.0.0.0
          allow_anonymous true
          persistence false
          CONF
          docker run -d --name mosquitto -p 1883:1883 \
            -v /tmp/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
            eclipse-mosquitto:2
          for i in {1..30}; do
            docker exec mosquitto mosquitto_pub -t 'health/check' -m 'ping' 2>/dev/null && break
            sleep 1
          done

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Run Sensor Config Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/06-config/config_sensor_add.yaml \
            2>&1 | tee config_sensor.log &
          WOKWI_PID=$!
          sleep 25

          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/config" \
            -m '{"sensors":[{"gpio":4,"sensor_type":"temp_ds18b20","sensor_name":"Test Sensor","active":true,"raw_mode":true}],"actuators":[]}'

          wait $WOKWI_PID && echo "Sensor Config: PASS" || echo "Sensor Config: FAIL (exit $?)"

      - name: Run Actuator Config Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/06-config/config_actuator_add.yaml \
            2>&1 | tee config_actuator.log &
          WOKWI_PID=$!
          sleep 25

          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/config" \
            -m '{"sensors":[],"actuators":[{"gpio":5,"actuator_type":"pwm","actuator_name":"LED Control","active":true}]}'

          wait $WOKWI_PID && echo "Actuator Config: PASS" || echo "Actuator Config: FAIL (exit $?)"

      - name: Stop Mosquitto
        if: always()
        run: docker stop mosquitto && docker rm mosquitto || true

      - name: Upload Config Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: config-test-logs
          path: El Trabajante/config_*.log
          retention-days: 7

  # ============================================
  # JOB 9: Sensor Flow Tests (E2E)
  # ============================================
  sensor-flow-tests:
    runs-on: ubuntu-latest
    needs: build-firmware
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/

      - name: Start Mosquitto MQTT Broker
        run: |
          mkdir -p /tmp/mosquitto
          echo -e "listener 1883 0.0.0.0\nallow_anonymous true\npersistence false" > /tmp/mosquitto/mosquitto.conf
          docker run -d --name mosquitto -p 1883:1883 \
            -v /tmp/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
            eclipse-mosquitto:2
          for i in {1..30}; do
            docker exec mosquitto mosquitto_pub -t 'health/check' -m 'ping' 2>/dev/null && break
            sleep 1
          done

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Run DS18B20 Full Flow Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/02-sensor/sensor_ds18b20_full_flow.yaml \
            2>&1 | tee sensor_ds18b20_full_flow.log || true

          echo "=== DS18B20 Full Flow Test Results ==="
          grep -q "Published" sensor_ds18b20_full_flow.log && echo "DS18B20 Full Flow: PASS" || echo "DS18B20 Full Flow: FAIL"

      - name: Run DHT22 Full Flow Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/02-sensor/sensor_dht22_full_flow.yaml \
            2>&1 | tee sensor_dht22_full_flow.log || true

          echo "=== DHT22 Full Flow Test Results ==="
          grep -q "Published" sensor_dht22_full_flow.log && echo "DHT22 Full Flow: PASS" || echo "DHT22 Full Flow: FAIL"

      - name: Run Analog Sensor Flow Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/02-sensor/sensor_analog_flow.yaml \
            2>&1 | tee sensor_analog_flow.log || true

          echo "=== Analog Sensor Flow Test Results ==="
          grep -q "Published" sensor_analog_flow.log && echo "Analog Flow: PASS" || echo "Analog Flow: FAIL"

      - name: Stop Mosquitto
        if: always()
        run: docker stop mosquitto && docker rm mosquitto || true

      - name: Upload Sensor Flow Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sensor-flow-test-logs
          path: El Trabajante/sensor_*_flow.log
          retention-days: 7

  # ============================================
  # JOB 10: Actuator Flow Tests (E2E)
  # ============================================
  actuator-flow-tests:
    runs-on: ubuntu-latest
    needs: build-firmware
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/

      - name: Start Mosquitto MQTT Broker
        run: |
          mkdir -p /tmp/mosquitto
          cat > /tmp/mosquitto/mosquitto.conf << 'CONF'
          listener 1883 0.0.0.0
          allow_anonymous true
          persistence false
          CONF
          docker run -d --name mosquitto -p 1883:1883 \
            -v /tmp/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
            eclipse-mosquitto:2
          for i in {1..30}; do
            docker exec mosquitto mosquitto_pub -t 'health/check' -m 'ping' 2>/dev/null && break
            sleep 1
          done

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Run Binary Actuator Full Flow Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/03-actuator/actuator_binary_full_flow.yaml \
            2>&1 | tee actuator_binary_full_flow.log &
          WOKWI_PID=$!
          sleep 25

          # ON Command
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/5/command" \
            -m '{"command":"ON","value":1.0}'
          sleep 5

          # OFF Command
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/5/command" \
            -m '{"command":"OFF"}'

          wait $WOKWI_PID && echo "Binary Full Flow: PASS" || echo "Binary Full Flow: FAIL (exit $?)"

      - name: Run PWM Actuator Full Flow Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 150 wokwi-cli . \
            --timeout 120000 \
            --scenario tests/wokwi/scenarios/03-actuator/actuator_pwm_full_flow.yaml \
            2>&1 | tee actuator_pwm_full_flow.log &
          WOKWI_PID=$!
          sleep 25

          # PWM 50%
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/13/command" \
            -m '{"command":"PWM","value":0.5}'
          sleep 3

          # PWM 100%
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/13/command" \
            -m '{"command":"PWM","value":1.0}'
          sleep 3

          # OFF
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/13/command" \
            -m '{"command":"OFF"}'

          wait $WOKWI_PID && echo "PWM Full Flow: PASS" || echo "PWM Full Flow: FAIL (exit $?)"

      - name: Run Actuator Timeout E2E Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 150 wokwi-cli . \
            --timeout 120000 \
            --scenario tests/wokwi/scenarios/03-actuator/actuator_timeout_e2e.yaml \
            2>&1 | tee actuator_timeout_flow.log &
          WOKWI_PID=$!
          sleep 25

          # ON with short timeout
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/5/command" \
            -m '{"command":"ON","value":1.0,"max_runtime_ms":5000}'

          wait $WOKWI_PID && echo "Timeout E2E: PASS" || echo "Timeout E2E: FAIL (exit $?)"

      - name: Stop Mosquitto
        if: always()
        run: docker stop mosquitto && docker rm mosquitto || true

      - name: Upload Actuator Flow Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: actuator-flow-test-logs
          path: El Trabajante/actuator_*_flow.log
          retention-days: 7

  # ============================================
  # JOB 11: Combined Flow Tests (E2E)
  # ============================================
  combined-flow-tests:
    runs-on: ubuntu-latest
    needs: build-firmware
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/

      - name: Start Mosquitto MQTT Broker
        run: |
          mkdir -p /tmp/mosquitto
          cat > /tmp/mosquitto/mosquitto.conf << 'CONF'
          listener 1883 0.0.0.0
          allow_anonymous true
          persistence false
          CONF
          docker run -d --name mosquitto -p 1883:1883 \
            -v /tmp/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
            eclipse-mosquitto:2
          for i in {1..30}; do
            docker exec mosquitto mosquitto_pub -t 'health/check' -m 'ping' 2>/dev/null && break
            sleep 1
          done

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Run Combined Sensor-Actuator Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 150 wokwi-cli . \
            --timeout 120000 \
            --scenario tests/wokwi/scenarios/07-combined/combined_sensor_actuator.yaml \
            2>&1 | tee combined_sensor_actuator.log &
          WOKWI_PID=$!
          sleep 25

          # Actuator ON (simulates Logic Engine trigger)
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/5/command" \
            -m '{"command":"ON","value":1.0}'
          sleep 10

          # Actuator OFF
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/5/command" \
            -m '{"command":"OFF"}'

          wait $WOKWI_PID && echo "Combined Sensor-Actuator: PASS" || echo "Combined Sensor-Actuator: FAIL (exit $?)"

      - name: Run Emergency Stop Full Flow Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 150 wokwi-cli . \
            --timeout 120000 \
            --scenario tests/wokwi/scenarios/05-emergency/emergency_stop_full_flow.yaml \
            2>&1 | tee emergency_stop_full_flow.log &
          WOKWI_PID=$!
          sleep 25

          # Activate actuator first
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/5/command" \
            -m '{"command":"ON","value":1.0}'
          sleep 3

          # Broadcast emergency stop
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/broadcast/emergency" \
            -m '{"auth_token":"master_token"}'
          sleep 5

          # Clear emergency
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/emergency" \
            -m '{"command":"emergency_clear","auth_token":"ESP_00000001"}'

          wait $WOKWI_PID && echo "Emergency Full Flow: PASS" || echo "Emergency Full Flow: FAIL (exit $?)"

      - name: Run Multi-Device Parallel Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 210 wokwi-cli . \
            --timeout 180000 \
            --scenario tests/wokwi/scenarios/07-combined/multi_device_parallel.yaml \
            2>&1 | tee multi_device_parallel.log &
          WOKWI_PID=$!
          sleep 25

          # Send actuator commands (sequential to avoid bare wait deadlock)
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/5/command" \
            -m '{"command":"ON","value":1.0}'
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/13/command" \
            -m '{"command":"PWM","value":0.7}'
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/14/command" \
            -m '{"command":"ON","value":1.0}'
          sleep 10

          # Cleanup: all OFF
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/5/command" \
            -m '{"command":"OFF"}'
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/14/command" \
            -m '{"command":"OFF"}'
          docker exec mosquitto mosquitto_pub \
            -t "kaiser/god/esp/ESP_00000001/actuator/13/command" \
            -m '{"command":"OFF"}'

          wait $WOKWI_PID && echo "Multi-Device Parallel: PASS" || echo "Multi-Device Parallel: FAIL (exit $?)"

      - name: Stop Mosquitto
        if: always()
        run: docker stop mosquitto && docker rm mosquitto || true

      - name: Upload Combined Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: combined-flow-test-logs
          path: |
            El Trabajante/combined_*.log
            El Trabajante/emergency_stop_full_flow.log
            El Trabajante/multi_device_parallel.log
          retention-days: 7

  # ============================================
  # JOB 12: Test Summary
  # ============================================
  test-summary:
    runs-on: ubuntu-latest
    needs: [boot-tests, sensor-tests, mqtt-connection-test, actuator-tests, zone-tests, emergency-tests, config-tests, sensor-flow-tests, actuator-flow-tests, combined-flow-tests]
    if: always()

    steps:
      - name: Download All Logs
        uses: actions/download-artifact@v4
        with:
          pattern: '*-test-logs'
          merge-multiple: true
          path: all-logs

      - name: Generate Test Summary
        run: |
          echo "# Wokwi ESP32 Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY

          # Check each test
          if [ -f all-logs/boot_full.log ]; then
            if grep -q "Phase 5: Actuator System READY" all-logs/boot_full.log; then
              echo "| Boot Full | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Boot Full | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Boot Full | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f all-logs/boot_safe_mode.log ]; then
            if grep -q "GPIO SAFE-MODE INITIALIZATION" all-logs/boot_safe_mode.log; then
              echo "| Safe-Mode | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Safe-Mode | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Safe-Mode | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f all-logs/sensor_heartbeat.log ]; then
            if grep -q "heartbeat" all-logs/sensor_heartbeat.log; then
              echo "| Heartbeat | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Heartbeat | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Heartbeat | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f all-logs/wokwi_mqtt_output.log ]; then
            if grep -q "MQTT connected" all-logs/wokwi_mqtt_output.log; then
              echo "| MQTT Connection | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| MQTT Connection | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| MQTT Connection | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
          fi

          # Actuator tests
          for test_file in actuator_led_on:Actuator:LED_ON actuator_pwm:PWM:PWM actuator_status:actuator:Status_Publish actuator_emergency_clear:EMERGENCY:Emergency_Clear; do
            IFS=: read -r file pattern label <<< "$test_file"
            if [ -f "all-logs/${file}.log" ]; then
              if grep -qi "$pattern" "all-logs/${file}.log"; then
                echo "| $label | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $label | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| $label | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # Zone tests
          for test_file in zone_assignment:"ZONE ASSIGNMENT RECEIVED":Zone_Assignment subzone_assignment:SUBZONE:Subzone_Assignment; do
            IFS=: read -r file pattern label <<< "$test_file"
            if [ -f "all-logs/${file}.log" ]; then
              if grep -q "$pattern" "all-logs/${file}.log"; then
                echo "| $label | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $label | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| $label | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # Emergency tests
          for test_file in emergency_broadcast:"BROADCAST EMERGENCY-STOP RECEIVED":Emergency_Broadcast emergency_esp_stop:"AUTHORIZED EMERGENCY-STOP TRIGGERED":ESP_Emergency_Stop; do
            IFS=: read -r file pattern label <<< "$test_file"
            if [ -f "all-logs/${file}.log" ]; then
              if grep -q "$pattern" "all-logs/${file}.log"; then
                echo "| $label | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $label | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| $label | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # Config tests
          for test_file in config_sensor:config:Sensor_Config config_actuator:config:Actuator_Config; do
            IFS=: read -r file pattern label <<< "$test_file"
            if [ -f "all-logs/${file}.log" ]; then
              if grep -qi "$pattern" "all-logs/${file}.log"; then
                echo "| $label | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $label | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| $label | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # E2E Sensor Flow tests
          for test_file in sensor_ds18b20_full_flow:Published:DS18B20_Full_Flow sensor_dht22_full_flow:Published:DHT22_Full_Flow sensor_analog_flow:Published:Analog_Flow; do
            IFS=: read -r file pattern label <<< "$test_file"
            if [ -f "all-logs/${file}.log" ]; then
              if grep -qi "$pattern" "all-logs/${file}.log"; then
                echo "| $label | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $label | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| $label | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # E2E Actuator Flow tests
          for test_file in actuator_binary_full_flow:Actuator:Binary_Full_Flow actuator_pwm_full_flow:Actuator:PWM_Full_Flow actuator_timeout_flow:timeout:Timeout_E2E; do
            IFS=: read -r file pattern label <<< "$test_file"
            if [ -f "all-logs/${file}.log" ]; then
              if grep -qi "$pattern" "all-logs/${file}.log"; then
                echo "| $label | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $label | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| $label | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # E2E Combined Flow tests
          for test_file in combined_sensor_actuator:Actuator:Combined_Sensor_Actuator emergency_stop_full_flow:"BROADCAST EMERGENCY-STOP":Emergency_Full_Flow multi_device_parallel:Actuator:Multi_Device_Parallel; do
            IFS=: read -r file pattern label <<< "$test_file"
            if [ -f "all-logs/${file}.log" ]; then
              if grep -q "$pattern" "all-logs/${file}.log"; then
                echo "| $label | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $label | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| $label | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Scenarios | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Boot & Core | 2 | 100% |" >> $GITHUB_STEP_SUMMARY
          echo "| Sensor & Heartbeat | 2 | 100% |" >> $GITHUB_STEP_SUMMARY
          echo "| MQTT Connection | 1 (legacy) | 100% |" >> $GITHUB_STEP_SUMMARY
          echo "| Actuator (MQTT Injection) | 4 | 100% |" >> $GITHUB_STEP_SUMMARY
          echo "| Zone (MQTT Injection) | 2 | 100% |" >> $GITHUB_STEP_SUMMARY
          echo "| Emergency (MQTT Injection) | 2 | 100% |" >> $GITHUB_STEP_SUMMARY
          echo "| Config (MQTT Injection) | 2 | 100% |" >> $GITHUB_STEP_SUMMARY
          echo "| **E2E Sensor Flows** | **3** | **100%** |" >> $GITHUB_STEP_SUMMARY
          echo "| **E2E Actuator Flows** | **3** | **100%** |" >> $GITHUB_STEP_SUMMARY
          echo "| **E2E Combined Flows** | **3** | **100%** |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **24** | **100%** |" >> $GITHUB_STEP_SUMMARY
