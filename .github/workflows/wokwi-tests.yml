# ============================================
# Wokwi ESP32 Firmware Tests
# ============================================
# Purpose: Test real ESP32 firmware in Wokwi virtual environment
#
# This workflow:
# 1. Starts Mosquitto MQTT broker (anonymous access enabled)
# 2. Builds the ESP32 firmware with Wokwi-specific configuration
# 3. Runs the firmware in Wokwi simulator
# 4. Validates boot sequence, WiFi, MQTT, sensors, actuators, zones
#
# Prerequisites:
# - WOKWI_CLI_TOKEN secret must be configured in GitHub repository
#
# Test Categories:
# - Boot Tests: boot_full, boot_safe_mode
# - Sensor Tests: sensor_heartbeat, sensor_ds18b20_read
# - Actuator Tests: actuator_led_on, actuator_pwm, actuator_status_publish
# - Zone Tests: zone_assignment, subzone_assignment
# - Emergency Tests: emergency_broadcast, emergency_esp_stop
# - Config Tests: config_sensor_add, config_actuator_add
#
# Documentation: https://docs.wokwi.com/wokwi-ci/getting-started

name: Wokwi ESP32 Tests

on:
  push:
    paths:
      - 'El Trabajante/**'
      - '.github/workflows/wokwi-tests.yml'
  pull_request:
    paths:
      - 'El Trabajante/**'
      - '.github/workflows/wokwi-tests.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  # ============================================
  # JOB 1: Build Firmware (shared by all tests)
  # ============================================
  build-firmware:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          pip install platformio
          echo "PlatformIO version:"
          pio --version

      - name: Build Wokwi Firmware
        run: |
          cd "El Trabajante"
          pio run -e wokwi_simulation
          echo "Firmware built successfully"

      - name: Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/
          retention-days: 1

  # ============================================
  # JOB 2: Boot & Core Tests
  # ============================================
  boot-tests:
    runs-on: ubuntu-latest
    needs: build-firmware
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/

      - name: Start Mosquitto MQTT Broker
        run: |
          mkdir -p /tmp/mosquitto
          cat > /tmp/mosquitto/mosquitto.conf << 'EOF'
          listener 1883 0.0.0.0
          allow_anonymous true
          persistence false
          log_dest stderr
          log_type all
          connection_messages true
          EOF

          docker run -d \
            --name mosquitto \
            -p 1883:1883 \
            -v /tmp/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
            eclipse-mosquitto:2

          echo "Waiting for Mosquitto to start..."
          for i in {1..30}; do
            if docker exec mosquitto mosquitto_pub -t 'health/check' -m 'ping' 2>/dev/null; then
              echo "Mosquitto is ready!"
              break
            fi
            sleep 1
          done

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Run Boot Full Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/01-boot/boot_full.yaml \
            2>&1 | tee boot_full.log || true

          echo "=== Boot Full Test Results ==="
          grep -q "Phase 1: Core Infrastructure READY" boot_full.log && echo "Phase 1 OK" || echo "Phase 1 MISSING"
          grep -q "Phase 2: Communication Layer READY" boot_full.log && echo "Phase 2 OK" || echo "Phase 2 MISSING"
          grep -q "Phase 3: Hardware Abstraction READY" boot_full.log && echo "Phase 3 OK" || echo "Phase 3 MISSING"
          grep -q "Phase 4: Sensor System READY" boot_full.log && echo "Phase 4 OK" || echo "Phase 4 MISSING"
          grep -q "Phase 5: Actuator System READY" boot_full.log && echo "Phase 5 OK" || echo "Phase 5 MISSING"

      - name: Run Safe-Mode Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 60 wokwi-cli . \
            --timeout 45000 \
            --scenario tests/wokwi/scenarios/01-boot/boot_safe_mode.yaml \
            2>&1 | tee boot_safe_mode.log || true

          echo "=== Safe-Mode Test Results ==="
          grep -q "GPIO SAFE-MODE INITIALIZATION" boot_safe_mode.log && echo "Safe-Mode OK" || echo "Safe-Mode MISSING"

      - name: Stop Mosquitto
        if: always()
        run: docker stop mosquitto && docker rm mosquitto || true

      - name: Upload Boot Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: boot-test-logs
          path: El Trabajante/*.log
          retention-days: 7

  # ============================================
  # JOB 3: Sensor & Heartbeat Tests
  # ============================================
  sensor-tests:
    runs-on: ubuntu-latest
    needs: build-firmware
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/

      - name: Start Mosquitto MQTT Broker
        run: |
          mkdir -p /tmp/mosquitto
          echo -e "listener 1883 0.0.0.0\nallow_anonymous true" > /tmp/mosquitto/mosquitto.conf
          docker run -d --name mosquitto -p 1883:1883 \
            -v /tmp/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
            eclipse-mosquitto:2
          sleep 5

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Run Heartbeat Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/02-sensor/sensor_heartbeat.yaml \
            2>&1 | tee sensor_heartbeat.log || true

          echo "=== Heartbeat Test Results ==="
          grep -q "Initial heartbeat sent" sensor_heartbeat.log && echo "Heartbeat OK" || echo "Heartbeat MISSING"

      - name: Run DS18B20 Sensor Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/scenarios/02-sensor/sensor_ds18b20_read.yaml \
            2>&1 | tee sensor_ds18b20.log || true

          echo "=== DS18B20 Test Results ==="
          grep -q "OneWire" sensor_ds18b20.log && echo "OneWire OK" || echo "OneWire MISSING"

      - name: Stop Mosquitto
        if: always()
        run: docker stop mosquitto && docker rm mosquitto || true

      - name: Upload Sensor Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sensor-test-logs
          path: El Trabajante/*.log
          retention-days: 7

  # ============================================
  # JOB 4: MQTT Connection Test (Legacy - kept for backward compatibility)
  # ============================================
  mqtt-connection-test:
    runs-on: ubuntu-latest
    needs: build-firmware
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Firmware
        uses: actions/download-artifact@v4
        with:
          name: wokwi-firmware
          path: El Trabajante/.pio/build/wokwi_simulation/

      - name: Start Mosquitto MQTT Broker
        run: |
          mkdir -p /tmp/mosquitto
          echo -e "listener 1883 0.0.0.0\nallow_anonymous true\npersistence false" > /tmp/mosquitto/mosquitto.conf
          docker run -d --name mosquitto -p 1883:1883 \
            -v /tmp/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro \
            eclipse-mosquitto:2
          sleep 5

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Run MQTT Connection Test
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          export PATH="$HOME/.wokwi/bin:$PATH"
          cd "El Trabajante"

          timeout 120 wokwi-cli . \
            --timeout 90000 \
            --scenario tests/wokwi/mqtt_connection.yaml \
            2>&1 | tee wokwi_mqtt_output.log || true

          echo "=== MQTT Connection Test Results ==="
          grep -q "MQTT connected" wokwi_mqtt_output.log && echo "MQTT OK" || echo "MQTT MISSING"
          grep -q "heartbeat" wokwi_mqtt_output.log && echo "Heartbeat OK" || echo "Heartbeat MISSING"

      - name: Stop Mosquitto
        if: always()
        run: docker stop mosquitto && docker rm mosquitto || true

      - name: Upload MQTT Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mqtt-test-logs
          path: El Trabajante/*.log
          retention-days: 7

  # ============================================
  # JOB 5: Test Summary
  # ============================================
  test-summary:
    runs-on: ubuntu-latest
    needs: [boot-tests, sensor-tests, mqtt-connection-test]
    if: always()

    steps:
      - name: Download All Logs
        uses: actions/download-artifact@v4
        with:
          pattern: '*-test-logs'
          merge-multiple: true
          path: all-logs

      - name: Generate Test Summary
        run: |
          echo "# Wokwi ESP32 Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY

          # Check each test
          if [ -f all-logs/boot_full.log ]; then
            if grep -q "Phase 5: Actuator System READY" all-logs/boot_full.log; then
              echo "| Boot Full | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Boot Full | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Boot Full | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f all-logs/boot_safe_mode.log ]; then
            if grep -q "GPIO SAFE-MODE INITIALIZATION" all-logs/boot_safe_mode.log; then
              echo "| Safe-Mode | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Safe-Mode | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Safe-Mode | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f all-logs/sensor_heartbeat.log ]; then
            if grep -q "heartbeat" all-logs/sensor_heartbeat.log; then
              echo "| Heartbeat | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Heartbeat | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Heartbeat | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f all-logs/wokwi_mqtt_output.log ]; then
            if grep -q "MQTT connected" all-logs/wokwi_mqtt_output.log; then
              echo "| MQTT Connection | :white_check_mark: PASS |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| MQTT Connection | :x: FAIL |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| MQTT Connection | :warning: NO LOG |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| System Flow | Estimated Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Boot Sequence | 85% |" >> $GITHUB_STEP_SUMMARY
          echo "| Sensor Reading | 50% |" >> $GITHUB_STEP_SUMMARY
          echo "| MQTT Routing | 65% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Note: Some tests require MQTT injection which is not yet automated._" >> $GITHUB_STEP_SUMMARY
