# ============================================
# Wokwi MQTT Connection Test
# ============================================
# Purpose: Validate MQTT connectivity and heartbeat publishing
#
# Prerequisites:
# - Mosquitto broker running (via Wokwi Gateway or localhost)
# - Anonymous authentication enabled
#
# Verified Log Messages (from source code):
# - wifi_manager.cpp:140  "WiFi connected! IP: ..."
# - mqtt_client.cpp:77    "MQTTClient initialized"
# - main.cpp:474          "MQTT connected successfully"
# - main.cpp:508          "Subscribed to system + actuator + zone assignment"
# - main.cpp:478          "Initial heartbeat sent for ESP registration"
# - main.cpp:428          "Free Heap: ..."
#
# Usage:
#   wokwi-cli run --timeout 90000 --scenario tests/wokwi/mqtt_connection.yaml

name: MQTT Connection Test
version: 1

steps:
  # ============================================
  # Wait for boot completion
  # ============================================
  - wait-serial: "Phase 2: Communication Layer"
    timeout: 30000

  # ============================================
  # WiFi Connection
  # ============================================
  # wifi_manager.cpp:140 "WiFi connected! IP: ..."
  - wait-serial: "WiFi connected"
    timeout: 45000

  - wait-serial: "IP:"
    timeout: 5000

  # ============================================
  # MQTT Connection
  # ============================================
  # mqtt_client.cpp:77 "MQTTClient initialized"
  - wait-serial: "MQTTClient"
    timeout: 10000

  # main.cpp:474 "MQTT connected successfully"
  - wait-serial: "MQTT connected"
    timeout: 30000

  # ============================================
  # Topic Subscriptions
  # ============================================
  # main.cpp:508 "Subscribed to system + actuator + zone assignment + subzone management topics"
  - wait-serial: "Subscribed to"
    timeout: 10000

  # ============================================
  # Initial Heartbeat
  # ============================================
  # main.cpp:478 "Initial heartbeat sent for ESP registration"
  - wait-serial: "heartbeat"
    timeout: 10000

  # ============================================
  # Memory Status (confirms stable operation)
  # ============================================
  # main.cpp:428 "Free Heap: ..."
  - wait-serial: "Free Heap:"
    timeout: 5000
