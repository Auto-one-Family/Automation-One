# HW-LIM-003: Sensor Limit Enforcement
# =====================================
# Validates that MAX_SENSORS limit is enforced and additional
# sensors beyond the limit are rejected.
#
# Test ID: HW-LIM-003
# Priority: HIGH
# Requirement:
#   - SensorManager enforces MAX_SENSORS limit
#   - Additional sensors are rejected with appropriate error
#
# Resource Limits (from platformio.ini):
#   ESP32-WROOM-32 (wokwi_simulation): MAX_SENSORS=20
#   XIAO ESP32-C3:                     MAX_SENSORS=10
#
# Note: This test verifies the MECHANISM works, not the exact limit.
# We configure several sensors and verify the manager is tracking count.
#
# Firmware references:
#   - platformio.ini: -DMAX_SENSORS=20 (esp32_dev)
#   - sensor_manager.cpp: Checks count before adding new sensor

name: Sensor Limit Enforcement
version: 1
steps:
  # Wait for boot to complete
  - wait-serial: "Phase 1: Core Infrastructure READY"

  # Wait for MQTT connection
  - wait-serial: "MQTT connected"

  # Configure first batch of sensors (5 sensors)
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/god/esp/ESP_00000001/config",
          "payload": {
            "sensors": [
              {"gpio": 4, "sensor_type": "temp_ds18b20", "sensor_name": "Sensor1", "active": true},
              {"gpio": 5, "sensor_type": "analog", "sensor_name": "Sensor2", "active": true},
              {"gpio": 14, "sensor_type": "analog", "sensor_name": "Sensor3", "active": true},
              {"gpio": 15, "sensor_type": "analog", "sensor_name": "Sensor4", "active": true},
              {"gpio": 16, "sensor_type": "analog", "sensor_name": "Sensor5", "active": true}
            ]
          }
        }

  # Verify sensors are being configured
  - wait-serial: "Sensor"

  # Wait for config processing
  - delay: 2000

  # Verify config response
  - wait-serial: "config_response"

  # Configure second batch of sensors (5 more = 10 total)
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/god/esp/ESP_00000001/config",
          "payload": {
            "sensors": [
              {"gpio": 17, "sensor_type": "analog", "sensor_name": "Sensor6", "active": true},
              {"gpio": 18, "sensor_type": "analog", "sensor_name": "Sensor7", "active": true},
              {"gpio": 19, "sensor_type": "analog", "sensor_name": "Sensor8", "active": true},
              {"gpio": 23, "sensor_type": "analog", "sensor_name": "Sensor9", "active": true},
              {"gpio": 25, "sensor_type": "analog", "sensor_name": "Sensor10", "active": true}
            ]
          }
        }

  # Wait for config processing
  - delay: 2000

  # Verify heartbeat shows sensor count
  # Heartbeat payload includes sensor_count field
  - wait-serial: "heartbeat"
