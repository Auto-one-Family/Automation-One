# HW-LIM-004: Actuator Limit Enforcement
# =======================================
# Validates that MAX_ACTUATORS limit is enforced and additional
# actuators beyond the limit are rejected.
#
# Test ID: HW-LIM-004
# Priority: HIGH
# Requirement:
#   - ActuatorManager enforces MAX_ACTUATORS limit
#   - Additional actuators are rejected with appropriate error
#
# Resource Limits (from platformio.ini):
#   ESP32-WROOM-32 (wokwi_simulation): MAX_ACTUATORS=12
#   XIAO ESP32-C3:                     MAX_ACTUATORS=6
#
# Note: This test verifies the MECHANISM works, not the exact limit.
# We configure several actuators and verify the manager is tracking count.
#
# Firmware references:
#   - platformio.ini: -DMAX_ACTUATORS=12 (esp32_dev)
#   - actuator_manager.cpp: Checks count before adding new actuator

name: Actuator Limit Enforcement
version: 1
steps:
  # Wait for boot to complete
  - wait-serial: "Phase 1: Core Infrastructure READY"

  # Wait for MQTT connection
  - wait-serial: "MQTT connected"

  # Configure first batch of actuators (4 actuators)
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/god/esp/ESP_00000001/config",
          "payload": {
            "actuators": [
              {"gpio": 5, "actuator_type": "led", "actuator_name": "LED1", "active": true},
              {"gpio": 14, "actuator_type": "relay", "actuator_name": "Relay1", "active": true},
              {"gpio": 15, "actuator_type": "pump", "actuator_name": "Pump1", "active": true},
              {"gpio": 16, "actuator_type": "relay", "actuator_name": "Relay2", "active": true}
            ]
          }
        }

  # Verify actuators are being configured
  - wait-serial: "Actuator"

  # Wait for config processing
  - delay: 2000

  # Verify config response
  - wait-serial: "config_response"

  # Configure second batch of actuators (4 more = 8 total)
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/god/esp/ESP_00000001/config",
          "payload": {
            "actuators": [
              {"gpio": 17, "actuator_type": "relay", "actuator_name": "Relay3", "active": true},
              {"gpio": 18, "actuator_type": "led", "actuator_name": "LED2", "active": true},
              {"gpio": 19, "actuator_type": "led", "actuator_name": "LED3", "active": true},
              {"gpio": 23, "actuator_type": "relay", "actuator_name": "Relay4", "active": true}
            ]
          }
        }

  # Wait for config processing
  - delay: 2000

  # Verify heartbeat shows actuator count
  # Heartbeat payload includes actuator_count field
  - wait-serial: "heartbeat"
