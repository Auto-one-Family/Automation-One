# HW-RES-001 to HW-RES-005: Reserved Pins Protection
# ===================================================
# Validates that RESERVED_GPIO_PINS are protected and cannot be used.
#
# Test IDs: HW-RES-001, HW-RES-002, HW-RES-003, HW-RES-004, HW-RES-005
# Priority: CRITICAL (Safety)
# Requirement:
#   - Boot pin (GPIO 0) is reserved
#   - UART pins (GPIO 1, 3) are reserved
#   - Flash strapping pins (GPIO 2, 12, 13 on WROOM) are reserved
#   - Sensor/Actuator config on reserved pins MUST fail
#
# Reserved Pins:
#   ESP32-WROOM-32: 0 (Boot), 1 (TX), 2 (Strapping), 3 (RX), 12, 13 (Flash)
#   XIAO ESP32-C3:  0 (Boot), 1 (TX), 3 (RX)
#
# Note: Flash pins GPIO 6-11 are not in RESERVED_GPIO_PINS but are
# also not in SAFE_GPIO_PINS, so they are implicitly blocked.
#
# Firmware references:
#   - esp32_dev.h lines 31-39: RESERVED_GPIO_PINS array
#   - gpio_manager.cpp: Rejects reserved pins

name: Reserved Pins Protection
version: 1
steps:
  # Wait for boot to complete
  - wait-serial: "Phase 1: Core Infrastructure READY"

  # Wait for MQTT connection
  - wait-serial: "MQTT connected"

  # TEST 1: Boot Pin (GPIO 0)
  # GPIO 0 is reserved for boot button
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/god/esp/ESP_00000001/config",
          "payload": {
            "sensors": [{
              "gpio": 0,
              "sensor_type": "digital_input",
              "sensor_name": "BootPinSensor",
              "active": true
            }]
          }
        }

  # Verify boot pin is rejected
  - wait-serial: "reserved"

  # Wait before next test
  - delay: 500

  # TEST 2: UART TX Pin (GPIO 1)
  # GPIO 1 is UART0 TX - must never be used
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/god/esp/ESP_00000001/config",
          "payload": {
            "actuators": [{
              "gpio": 1,
              "actuator_type": "relay",
              "actuator_name": "UARTRelay",
              "active": true
            }]
          }
        }

  # Verify UART pin is rejected
  - wait-serial: "reserved"

  # Wait before next test
  - delay: 500

  # TEST 3: UART RX Pin (GPIO 3)
  # GPIO 3 is UART0 RX - must never be used
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/god/esp/ESP_00000001/config",
          "payload": {
            "sensors": [{
              "gpio": 3,
              "sensor_type": "analog",
              "sensor_name": "RXSensor",
              "active": true
            }]
          }
        }

  # Verify RX pin is rejected
  - wait-serial: "reserved"

  # Wait before next test
  - delay: 500

  # TEST 4: Flash Strapping Pin (GPIO 12) - WROOM specific
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/god/esp/ESP_00000001/config",
          "payload": {
            "actuators": [{
              "gpio": 12,
              "actuator_type": "pump",
              "actuator_name": "FlashPump",
              "active": true
            }]
          }
        }

  # Verify flash strapping pin is rejected
  - wait-serial: "reserved"

  # Wait before next test
  - delay: 500

  # TEST 5: Flash Pin (GPIO 6) - Internal Flash SPI
  # Note: Not in RESERVED_GPIO_PINS but also not in SAFE_GPIO_PINS
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/god/esp/ESP_00000001/config",
          "payload": {
            "sensors": [{
              "gpio": 6,
              "sensor_type": "digital_input",
              "sensor_name": "FlashSensor",
              "active": true
            }]
          }
        }

  # Verify internal flash pin is rejected (not in safe pins)
  - wait-serial: "not in safe pins"
