# GPIO-INT-003: Safety Controller Integration
# ============================================
# Validates that SafetyController correctly uses GPIO Manager
# for emergency stop operations (enableSafeModeForAllPins).
#
# Test ID: GPIO-INT-003
# Priority: CRITICAL (Safety)
# Requirement: safetyController.emergencyStopAll() calls gpioManager.enableSafeModeForAllPins()
#
# Integration Flow:
#   1. Emergency command received (MQTT broadcast or ESP-specific)
#   2. SafetyController.emergencyStopAll() is called
#   3. SafetyController calls gpioManager.enableSafeModeForAllPins()
#   4. GPIO Manager de-energizes all OUTPUT pins
#   5. All pins return to INPUT_PULLUP safe state
#   6. Emergency status is published via MQTT
#
# Safety Chain:
#   MQTT Message -> SafetyController -> GPIOManager -> Hardware
#
# Firmware reference:
#   - safety_controller.cpp (emergencyStopAll method)
#   - gpio_manager.cpp (enableSafeModeForAllPins method)

name: Safety Controller GPIO Integration
version: 1
steps:
  # Wait for boot to complete
  - wait-serial: "Phase 1: Core Infrastructure READY"

  # Wait for Safety Controller initialization
  - wait-serial: "Safety Controller initialized"

  # Wait for MQTT connection
  - wait-serial: "MQTT connected"

  # Configure multiple actuators (all OUTPUT pins)
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/god/esp/ESP_00000001/config",
          "payload": {
            "actuators": [
              { "gpio": 5, "actuator_type": "pump", "actuator_name": "Pump1", "active": true },
              { "gpio": 14, "actuator_type": "valve", "actuator_name": "Valve1", "active": true },
              { "gpio": 15, "actuator_type": "fan", "actuator_name": "Fan1", "active": true }
            ]
          }
        }

  # Verify all actuators configured
  - wait-serial: "Pin 5 allocated"
  - wait-serial: "Pin 14 allocated"
  - wait-serial: "Pin 15 allocated"

  # Turn ON all actuators
  - delay: 500
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/god/esp/ESP_00000001/actuator/5/command",
          "payload": { "command": "ON" }
        }

  - delay: 100
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/god/esp/ESP_00000001/actuator/14/command",
          "payload": { "command": "ON" }
        }

  - delay: 100
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/god/esp/ESP_00000001/actuator/15/command",
          "payload": { "command": "ON" }
        }

  # Verify actuators are ON
  - delay: 500

  # TRIGGER EMERGENCY STOP via SafetyController
  - set-control:
      part-id: "mqtt"
      control: "inject"
      value: |
        {
          "topic": "kaiser/broadcast/emergency",
          "payload": {
            "command": "STOP",
            "reason": "Integration test emergency"
          }
        }

  # Verify SafetyController processes emergency
  - wait-serial: "Emergency"

  # Verify GPIO Manager is called
  - wait-serial: "Emergency safe-mode activated"

  # Verify de-energization happens
  - wait-serial: "de-energized"

  # Verify all pins return to safe mode
  - wait-serial: "All pins returned to safe mode"

  # Verify emergency status is published
  # (MQTT publish to actuator/emergency topic)
