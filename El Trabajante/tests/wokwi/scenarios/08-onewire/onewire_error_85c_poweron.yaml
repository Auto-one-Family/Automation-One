# OneWire DS18B20 Power-On Reset Value 85°C Detection (OW-ERR-CRITICAL-002)
# ============================================================================
# PRIORITY: CRITICAL
# CATEGORY: error-handling, sensor-validation
#
# REAL-WORLD SCENARIO:
# After power-on, the DS18B20 returns 85°C (RAW: 1360) as factory default
# BEFORE the first conversion command completes. If this value is published
# as valid data, the server thinks the greenhouse is at 85°C and activates
# maximum cooling - wasting energy and potentially damaging equipment.
#
# DS18B20 BEHAVIOR:
# - Returns 85°C (RAW: 1360) immediately after power-on reset
# - This is the factory default value in the scratchpad
# - First VALID reading requires: Convert (0x44) + 750ms wait + Read
# - 85°C is also within valid temperature range, making detection harder
#
# EXPECTED FIRMWARE BEHAVIOR:
# 1. Detect 85°C on FIRST reading after power-on as potential reset value
# 2. Log WARNING with "power-on", "reset", "retry", or "85"
# 3. Retry measurement before accepting 85°C as valid
# 4. Only publish after confirming value is stable (2+ consistent readings)
#
# WOKWI LIMITATION:
# The Wokwi DS18B20 simulator returns the configured temperature immediately.
# It does NOT simulate the power-on reset behavior with 85°C default.
# This test documents EXPECTED behavior for code review.
#
# FIRMWARE GAP IDENTIFIED (2026-01-29):
# File: El Trabajante/src/drivers/onewire_bus.cpp
# Function: readRawTemperature()
# Status: NO detection of 85°C power-on reset value exists
# The function returns true with raw_value=1360 without checking!
#
# REQUIRED FIRMWARE FIX:
# Add validation in readRawTemperature() or SensorManager:
#   static bool first_reading = true;
#   if (first_reading && raw_value == 1360) {  // 85°C in 1/16th degree units
#       LOG_WARNING("DS18B20 power-on reset detected: 85°C - retrying");
#       first_reading = false;
#       delay(100);  // Short delay before retry
#       return readRawTemperature(rom_code, raw_value);  // Retry
#   }
#   first_reading = false;
#
# ALTERNATIVE: Track per-sensor state and validate first N readings
# ============================================================================

name: DS18B20 Power-On Reset Value 85°C Detection
version: 1

# NOTE: This test will PASS in Wokwi because the simulator does not return
# 85°C on power-on. The test documents expected behavior for code review.

steps:
  # ============================================
  # PHASE 1: SYSTEM BOOT
  # ============================================
  - wait-serial: "Phase 3: Hardware Abstraction READY"

  # ============================================
  # PHASE 2: ONEWIRE INITIALIZATION
  # ============================================
  - wait-serial: "OneWire Bus Manager initialized"

  # ============================================
  # PHASE 3: SENSOR DISCOVERY
  # ============================================
  - wait-serial: "Found device: Family=0x28"

  # ============================================
  # PHASE 4: FIRST TEMPERATURE READING
  # ============================================
  # In Wokwi, this shows configured temperature (22.5°C)
  # On real hardware without fix, this could show 85°C
  # With firmware fix, we would see WARNING about power-on reset
  - wait-serial: "OneWire raw temperature"

  # ============================================
  # PHASE 5: SYSTEM OPERATIONAL
  # ============================================
  # System continues to heartbeat
  - wait-serial: "heartbeat"

  # ============================================
  # VERIFICATION NOTE:
  # On REAL hardware or with firmware fix, we expect:
  # - "WARNING" or "warning"
  # - "power-on" or "reset"
  # - "retry" or "retrying"
  # - "85" or "1360"
  # - Second reading taken before publishing
  # ============================================
